<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Simple Pet Selector</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    /* Copy CSS from simplified selector */
    .pet-selector {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      max-width: 600px;
    }

    .pet-selector__header h3 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .pet-selector__grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .pet-thumbnail {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s ease;
    }

    .pet-thumbnail.selected {
      border-color: #FF6B6B;
      transform: scale(1.02);
    }

    .pet-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .pet-delete {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #dc3545;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .pet-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px;
      font-size: 11px;
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
    }

    .empty-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 16px;
    }

    .btn-upload {
      display: inline-block;
      padding: 12px 24px;
      background: #FF6B6B;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      margin-top: 12px;
    }

    @media (min-width: 768px) {
      .pet-selector__grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 16px;
      }
    }
    
    /* Test controls */
    .test-controls {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }
    
    .test-controls button {
      margin: 5px;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .test-controls button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Simple Pet Selector Test</h1>
  
  <div class="test-controls">
    <h3>Test Controls</h3>
    <button onclick="addTestPet('Fluffy', 'color')">Add Pet: Fluffy</button>
    <button onclick="addTestPet('Max', 'enhancedblackwhite')">Add Pet: Max (B&W)</button>
    <button onclick="addTestPet('Bella', 'popart')">Add Pet: Bella (Pop Art)</button>
    <button onclick="clearAllPets()">Clear All Pets</button>
    <button onclick="showStorageInfo()">Show Storage Info</button>
  </div>

  <div class="pet-selector" data-section-id="test">
    <div class="pet-selector__header">
      <h3>Select Your Pet Image</h3>
      <p>Choose from saved pets or <a href="#" onclick="alert('Would navigate to pet processor'); return false;">create new</a></p>
    </div>
    
    <div class="pet-selector__grid" id="pet-grid-test">
      <!-- Populated by JavaScript -->
    </div>
    
    <div class="pet-selector__empty" id="pet-empty-test" style="display:none">
      <div class="empty-state">
        <span class="empty-icon">ðŸ“¸</span>
        <h4>Add Your Pet Photo</h4>
        <p>FREE background removal included</p>
        <a href="#" onclick="alert('Would navigate to pet processor'); return false;" class="btn-upload">Upload Photo</a>
      </div>
    </div>
  </div>

  <script>
    // Initialize window.perkieEffects if not exists
    if (!window.perkieEffects) {
      window.perkieEffects = new Map();
    }

    // Test data - small base64 images
    const testImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjZmZmIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiI+UGV0PC90ZXh0Pjwvc3ZnPg==';
    
    // Add test pet function
    function addTestPet(name, effect) {
      const sessionKey = name + '_' + Date.now();
      const key = sessionKey + '_' + effect;
      window.perkieEffects.set(key, testImage);
      console.log('Added pet:', key);
      renderThumbnails();
    }
    
    // Clear all pets
    function clearAllPets() {
      window.perkieEffects.clear();
      console.log('Cleared all pets');
      renderThumbnails();
    }
    
    // Show storage info
    function showStorageInfo() {
      console.log('perkieEffects Map contents:');
      window.perkieEffects.forEach((value, key) => {
        console.log(`  ${key}: [image data ${value.length} chars]`);
      });
      alert(`Storage contains ${window.perkieEffects.size} pet effect(s)`);
    }

    // Simplified pet selector code
    (function() {
      'use strict';
      
      const sectionId = 'test';
      const gridEl = document.getElementById('pet-grid-' + sectionId);
      const emptyEl = document.getElementById('pet-empty-' + sectionId);
      let selectedPet = null;

      // Extract pets from window.perkieEffects Map
      function extractPets() {
        if (!window.perkieEffects || !window.perkieEffects.size) return [];
        
        const pets = {};
        window.perkieEffects.forEach(function(imageUrl, key) {
          // Parse key format: sessionKey_effectType
          const parts = key.split('_');
          const effectType = parts.pop();
          const sessionKey = parts.join('_');
          
          if (!pets[sessionKey]) {
            pets[sessionKey] = {
              id: sessionKey,
              name: sessionKey.replace(/_/g, ' '),
              thumbnail: null
            };
          }
          
          // Use color effect as thumbnail, fallback to any effect
          if (effectType === 'color' || !pets[sessionKey].thumbnail) {
            pets[sessionKey].thumbnail = imageUrl;
          }
        });
        
        return Object.values(pets);
      }

      // Render thumbnail grid
      window.renderThumbnails = function() {
        const pets = extractPets();
        
        if (!pets.length) {
          gridEl.style.display = 'none';
          emptyEl.style.display = 'block';
          return;
        }

        gridEl.innerHTML = pets.map(function(pet) {
          return '<div class="pet-thumbnail" data-pet-id="' + pet.id + '">' +
            '<img src="' + pet.thumbnail + '" alt="' + pet.name + '">' +
            '<button class="pet-delete" data-pet-id="' + pet.id + '" aria-label="Delete">Ã—</button>' +
            '<div class="pet-name">' + pet.name + '</div>' +
          '</div>';
        }).join('');

        gridEl.style.display = 'grid';
        emptyEl.style.display = 'none';
        
        // Add event listeners
        gridEl.querySelectorAll('.pet-thumbnail').forEach(function(thumb) {
          thumb.addEventListener('click', handleSelect);
        });
        
        gridEl.querySelectorAll('.pet-delete').forEach(function(btn) {
          btn.addEventListener('click', handleDelete);
        });
      }

      // Handle pet selection
      function handleSelect(e) {
        if (e.target.classList.contains('pet-delete')) return;
        
        const petId = e.currentTarget.dataset.petId;
        
        // Update UI
        gridEl.querySelectorAll('.pet-thumbnail').forEach(function(t) {
          t.classList.remove('selected');
        });
        e.currentTarget.classList.add('selected');
        
        selectedPet = petId;
        console.log('Selected pet:', petId);
      }

      // Handle pet deletion
      function handleDelete(e) {
        e.stopPropagation();
        const petId = e.currentTarget.dataset.petId;
        
        if (confirm('Remove this pet?')) {
          // Remove from storage
          const keysToDelete = [];
          window.perkieEffects.forEach(function(_, key) {
            if (key.indexOf(petId) === 0) {
              keysToDelete.push(key);
            }
          });
          
          keysToDelete.forEach(function(key) {
            window.perkieEffects.delete(key);
          });
          
          console.log('Deleted pet:', petId);
          
          // Re-render
          renderThumbnails();
        }
      }

      // Initialize
      function init() {
        renderThumbnails();
      }

      // Start when ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>