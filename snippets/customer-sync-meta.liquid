{% comment %}
  Customer Sync Metadata
  Injects customer information for cross-device session sync
  Phase 2 - Cloud Session Management
{% endcomment %}

{% if customer %}
  <meta name="customer-id" content="{{ customer.id }}">
  <meta name="customer-email" content="{{ customer.email }}">
  <meta name="customer-logged-in" content="true">
  
  {% comment %} Check for existing pet sessions in customer metafields {% endcomment %}
  {% if customer.metafields.perkie_pets.pet_sessions %}
    <script type="application/json" id="customer-pet-sessions">
      {{ customer.metafields.perkie_pets.pet_sessions }}
    </script>
  {% endif %}
{% else %}
  <meta name="customer-logged-in" content="false">
{% endif %}

{% comment %} Load sync scripts - Removed: Missing files causing 404 errors
<script src="{{ 'shopify-customer-sync.js' | asset_url }}" defer></script>
<script src="{{ 'guest-email-capture.js' | asset_url }}" defer></script>
{% endcomment %}
{% comment %} Legacy phase2-session-integration.js removed - replaced by v4 modules {% endcomment %}

{% comment %} Initialize customer sync after DOM ready {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Check if customer data is available in Shopify Analytics
    if (window.ShopifyAnalytics && window.ShopifyAnalytics.meta) {
      const meta = window.ShopifyAnalytics.meta;
      
      {% if customer %}
        // Ensure customer data is set
        meta.page = meta.page || {};
        meta.page.customerId = '{{ customer.id }}';
        meta.page.customerEmail = '{{ customer.email }}';
      {% endif %}
    }
    
    // Trigger customer login event if logged in
    {% if customer %}
      setTimeout(function() {
        window.dispatchEvent(new CustomEvent('customer:login', {
          detail: {
            id: '{{ customer.id }}',
            email: '{{ customer.email }}',
            firstName: '{{ customer.first_name }}',
            lastName: '{{ customer.last_name }}'
          }
        }));
      }, 100);
    {% endif %}
  });
</script>

{% comment %} Session recovery for guest users {% endcomment %}
{% if request.page_type == 'page' and page.handle == 'recover-pet-sessions' %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check for session recovery parameters
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session');
      
      if (sessionId && window.shopifyCustomerSync) {
        window.shopifyCustomerSync.recoverSessions(sessionId).then(function(success) {
          if (success) {
            // Show success message
            const message = document.createElement('div');
            message.className = 'session-recovery-message session-recovery-message--success';
            message.innerHTML = `
              <div class="session-recovery-message__content">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M20 6L9 17l-5-5" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <h3>Sessions Recovered Successfully!</h3>
                <p>Your pet customizations have been restored. You can continue where you left off.</p>
                <a href="/collections/all" class="button">Continue Shopping</a>
              </div>
            `;
            document.body.appendChild(message);
          } else {
            // Show error message
            const message = document.createElement('div');
            message.className = 'session-recovery-message session-recovery-message--error';
            message.innerHTML = `
              <div class="session-recovery-message__content">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <h3>Session Recovery Failed</h3>
                <p>We couldn't find your saved sessions. The link may have expired or been used already.</p>
                <a href="/collections/all" class="button">Start Fresh</a>
              </div>
            `;
            document.body.appendChild(message);
          }
        });
      }
    });
  </script>
  
  <style>
    .session-recovery-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 32px;
      max-width: 480px;
      width: 90%;
      text-align: center;
    }
    
    .session-recovery-message svg {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
    }
    
    .session-recovery-message--success svg {
      stroke: #4CAF50;
    }
    
    .session-recovery-message--error svg {
      stroke: #f44336;
    }
    
    .session-recovery-message h3 {
      margin: 0 0 8px;
      font-size: 24px;
    }
    
    .session-recovery-message p {
      margin: 0 0 24px;
      color: #666;
    }
    
    .session-recovery-message .button {
      display: inline-block;
      padding: 12px 32px;
      background: #333;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    .session-recovery-message .button:hover {
      background: #555;
    }
  </style>
{% endif %}