var EffectsV2;(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>a});const i=new class{constructor(){this.baseUrl="https://gemini-artistic-api-3km6z2qpyq-uc.a.run.app",this.cache=new Map,this.pending=new Map,this.maxRetries=2,this.timeout=6e4,this.rateLimitKey="gemini_artistic_rate_limit",this.maxRequestsPerDay=5}checkRateLimit(){const t=localStorage.getItem(this.rateLimitKey),e=new Date;if(!t)return{allowed:!0,remaining:this.maxRequestsPerDay-1,resetTime:this.getNextResetTime(e)};const i=JSON.parse(t),s=new Date(i.resetTime);return e>=s?{allowed:!0,remaining:this.maxRequestsPerDay-1,resetTime:this.getNextResetTime(e)}:i.count>=this.maxRequestsPerDay?{allowed:!1,remaining:0,resetTime:s}:{allowed:!0,remaining:this.maxRequestsPerDay-i.count-1,resetTime:s}}getNextResetTime(t){const e=new Date(t);return e.setDate(e.getDate()+1),e.setHours(0,0,0,0),e}incrementRateLimit(){const t=localStorage.getItem(this.rateLimitKey),e=new Date;if(!t)return void localStorage.setItem(this.rateLimitKey,JSON.stringify({count:1,resetTime:this.getNextResetTime(e).toISOString()}));const i=JSON.parse(t);e>=new Date(i.resetTime)?localStorage.setItem(this.rateLimitKey,JSON.stringify({count:1,resetTime:this.getNextResetTime(e).toISOString()})):(i.count++,localStorage.setItem(this.rateLimitKey,JSON.stringify(i)))}async applyStyle(t,e){const i=this.checkRateLimit();if(!i.allowed){const t=Math.ceil((i.resetTime-new Date)/36e5);throw new Error(`Rate limit exceeded. You have used all ${this.maxRequestsPerDay} Modern/Classic style requests today. Please try again in ${t} hours.`)}const s={modern:"ink_wash",classic:"van_gogh_post_impressionism"}[e];if(!s)throw new Error(`Invalid style: ${e}. Must be 'modern' or 'classic'.`);const a=new FormData;a.append("image",t,"pet.png"),a.append("style",s);try{const t=await this.request("/generate-artistic",{method:"POST",body:a,timeout:6e4});return this.incrementRateLimit(),t}catch(t){throw console.error("Gemini artistic style failed:",t),t}}async request(t,e={}){const i=`${this.baseUrl}${t}`,s=this.getCacheKey(i,e);if("GET"===e.method&&this.cache.has(s)){const t=this.cache.get(s);if(!this.isStale(t))return t.data}if(this.pending.has(s))return this.pending.get(s);const a=this.executeWithRetry(i,e);this.pending.set(s,a);try{const t=await a;return this.pending.delete(s),"GET"===e.method&&this.cache.set(s,{data:t,timestamp:Date.now()}),t}catch(t){throw this.pending.delete(s),t}}async executeWithRetry(t,e,i=1){try{const i=new AbortController,s=e.timeout||this.timeout,a=setTimeout(()=>{i.abort()},s),r=await fetch(t,{...e,signal:i.signal,mode:"cors",headers:{...e.headers}});if(clearTimeout(a),!r.ok){const t=await r.text();throw new Error(`Gemini API error ${r.status}: ${t}`)}const n=r.headers.get("content-type");return n&&n.includes("application/json")?await r.json():n&&n.startsWith("image/")?await r.blob():await r.text()}catch(s){if(i<this.maxRetries&&this.isRetryableError(s))return console.warn(`Gemini API request failed (attempt ${i}/${this.maxRetries}), retrying...`,s.message),await this.delay(1e3*i),this.executeWithRetry(t,e,i+1);throw s}}isRetryableError(t){return"AbortError"===t.name||t.message.includes("NetworkError")||t.message.includes("500")||t.message.includes("502")||t.message.includes("503")||t.message.includes("504")}getCacheKey(t,e){return`${e.method||"GET"}:${t}`}isStale(t){return Date.now()-t.timestamp>36e5}delay(t){return new Promise(e=>setTimeout(e,t))}async healthCheck(){try{return await this.request("/health",{method:"GET",timeout:5e3})}catch(t){throw console.error("Gemini API health check failed:",t),t}}getAvailableStyles(){return[{id:"modern",name:"Modern",description:"Ink wash artistic style with soft, flowing brushstrokes",geminiStyle:"ink_wash"},{id:"classic",name:"Classic",description:"Van Gogh post-impressionism with bold colors and expressive strokes",geminiStyle:"van_gogh_post_impressionism"}]}clearRateLimit(){localStorage.removeItem(this.rateLimitKey),console.log("Rate limit cleared")}};class s{constructor(){this.canvas=null,this.ctx=null,this.worker=null,this.supportsWebP=this.checkWebPSupport(),this.effects={original:this.original.bind(this),color:this.original.bind(this),blackwhite:this.blackwhite.bind(this)},this.geminiEffects=["modern","classic"]}async apply(t,e,i=1){if(this.geminiEffects.includes(e))return await this.applyGeminiEffect(t,e);if(!this.effects[e])throw new Error(`Unknown effect: ${e}`);const s=await this.loadImage(t);console.log("🔧 Canvas processing:",e,s.width+"x"+s.height);const a=s.width,r=s.height;return this.canvas?this.resizeCanvas(a,r):this.initCanvas(a,r),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(s,0,0,a,r),console.log("🔄 Using API image directly - correct orientation preserved"),"original"!==e&&"color"!==e&&await this.effects[e](this.ctx,s),this.getOptimizedResult()}async applyGeminiEffect(t,e){console.log("🎨 Gemini processing:",e);try{const s=i.checkRateLimit();if(!s.allowed){const t=Math.ceil((s.resetTime-new Date)/36e5);throw new Error(`Rate limit exceeded. You've used all ${i.maxRequestsPerDay} ${e} requests today. Resets in ${t}h.`)}const a=await fetch(t),r=await a.blob(),n=await i.applyStyle(r,e),c=URL.createObjectURL(n);return console.log("✅ Gemini effect applied:",e),c}catch(t){throw console.error("❌ Gemini effect failed:",t),t}}initCanvas(t,e){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!0}),this.resizeCanvas(t,e)}resizeCanvas(t,e){const i=1024;if(t>i||e>i){const s=i/Math.max(t,e);t=Math.floor(t*s),e=Math.floor(e*s)}this.canvas.width=t,this.canvas.height=e}async loadImage(t){return new Promise((e,i)=>{const s=new Image;s.crossOrigin="anonymous",s.onload=()=>{e(s)},s.onerror=i,s.src=t})}getRotatedDimensions(t,e,i){return i>=5&&i<=8?{width:e,height:t}:{width:t,height:e}}drawRotatedImage(t,e){const{width:i,height:s}=this.getRotatedDimensions(t.width,t.height,e);switch(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),e){case 2:this.ctx.translate(i,0),this.ctx.scale(-1,1);break;case 3:this.ctx.translate(i,s),this.ctx.rotate(Math.PI);break;case 4:this.ctx.translate(0,s),this.ctx.scale(1,-1);break;case 5:this.ctx.translate(0,s),this.ctx.rotate(-Math.PI/2),this.ctx.scale(-1,1);break;case 6:this.ctx.translate(s,0),this.ctx.rotate(Math.PI/2);break;case 7:this.ctx.translate(s,i),this.ctx.rotate(Math.PI/2),this.ctx.scale(-1,1);break;case 8:this.ctx.translate(0,i),this.ctx.rotate(-Math.PI/2)}this.ctx.drawImage(t,0,0,t.width,t.height),this.ctx.restore()}original(t,e){}blackwhite(t,e){const i=t.getImageData(0,0,this.canvas.width,this.canvas.height),s=i.data;for(let t=0;t<s.length;t+=4){const e=.299*s[t]+.587*s[t+1]+.114*s[t+2],i=this.enhanceContrast(e,1.2);s[t]=i,s[t+1]=i,s[t+2]=i}t.putImageData(i,0,0)}enhanceContrast(t,e){return 255*((t/255-.5)*e+.5)}async getOptimizedResult(){const t=this.supportsWebP?"webp":"png";return new Promise(e=>{this.canvas.toBlob(t=>{e(URL.createObjectURL(t))},`image/${t}`,.85)})}checkWebPSupport(){const t=document.createElement("canvas");t.width=1,t.height=1;const e=t.getContext("2d");return e.fillStyle="#000",e.fillRect(0,0,1,1),5===t.toDataURL("image/webp").indexOf("image/webp")}async generateThumbnail(t,e=150){const i=await this.loadImage(t),s=document.createElement("canvas"),a=s.getContext("2d"),r=i.width/i.height;let n=e,c=e;return r>1?c=e/r:n=e*r,s.width=n,s.height=c,a.drawImage(i,0,0,n,c),s.toDataURL("image/webp",.7)}async generatePreviews(t,e=["original","blackwhite","modern","classic"]){const i=new Map;for(const s of e)try{const e=await this.apply(t,s),a=await this.generateThumbnail(e,150);i.set(s,{full:e,thumbnail:a})}catch(t){console.error(`Failed to generate preview for ${s}:`,t),this.geminiEffects.includes(s)&&i.set(s,{full:null,thumbnail:null,error:t.message})}return i}cleanup(){this.canvas&&(this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null),this.worker&&(this.worker.terminate(),this.worker=null)}}const a={EffectProcessor:s,geminiClient:i};"undefined"!=typeof window&&(window.EffectsV2={EffectProcessor:s,geminiClient:i}),EffectsV2=e.default})();
//# sourceMappingURL=effects-v2-bundle.js.map