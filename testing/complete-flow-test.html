<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Pet Processing Flow Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    h2 {
      color: #555;
      margin-top: 0;
    }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 14px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 16px;
    }
    
    button:hover {
      background: #45a049;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .test-results {
      margin-top: 20px;
    }
    
    .test-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .test-item:last-child {
      border-bottom: none;
    }
    
    .test-icon {
      margin-right: 10px;
      font-size: 20px;
    }
    
    .test-description {
      flex: 1;
    }
    
    .test-time {
      color: #666;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .data-preview {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üß™ Complete Pet Processing Flow Test</h1>
  
  <div class="test-section">
    <h2>Test Configuration</h2>
    <div class="status info">
      <strong>Test Environment:</strong> Development<br>
      <strong>API Endpoint:</strong> https://inspirenet-bg-removal-api-725543555429.us-central1.run.app<br>
      <strong>Test Date:</strong> <span id="test-date"></span>
    </div>
  </div>
  
  <div class="test-section">
    <h2>1. File Upload & Processing</h2>
    <input type="file" id="test-file" accept="image/*">
    <button onclick="testUploadAndProcess()" id="upload-btn">Test Upload & Process</button>
    <div id="upload-status"></div>
  </div>
  
  <div class="test-section">
    <h2>2. Effect Selection & Switching</h2>
    <button onclick="testEffectSwitching()" id="effect-btn" disabled>Test Effect Switching</button>
    <div id="effect-status"></div>
  </div>
  
  <div class="test-section">
    <h2>3. Pet Name Capture</h2>
    <button onclick="testPetNameCapture()" id="name-btn" disabled>Test Pet Name Capture</button>
    <div id="name-status"></div>
  </div>
  
  <div class="test-section">
    <h2>4. Artist Notes</h2>
    <button onclick="testArtistNotes()" id="notes-btn" disabled>Test Artist Notes</button>
    <div id="notes-status"></div>
  </div>
  
  <div class="test-section">
    <h2>5. Cart Integration</h2>
    <button onclick="testCartIntegration()" id="cart-btn" disabled>Test Cart Properties</button>
    <div id="cart-status"></div>
  </div>
  
  <div class="test-section">
    <h2>6. Cross-Page Persistence</h2>
    <button onclick="testPersistence()" id="persist-btn" disabled>Test LocalStorage Persistence</button>
    <div id="persist-status"></div>
  </div>
  
  <div class="test-section">
    <h2>7. Cold Start Estimation</h2>
    <button onclick="testColdStart()" id="cold-btn">Test Cold Start Estimates</button>
    <div id="cold-status"></div>
  </div>
  
  <div class="test-section">
    <h2>Test Results Summary</h2>
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width: 0%">0%</div>
    </div>
    <div class="test-results" id="results"></div>
  </div>
  
  <div class="test-section">
    <h2>Data Inspector</h2>
    <button onclick="inspectData()">Inspect All Data</button>
    <div class="data-preview" id="data-preview"></div>
  </div>
  
  <script>
    // Test tracking
    let testResults = [];
    let currentSessionKey = null;
    let testFile = null;
    
    // Initialize test date
    document.getElementById('test-date').textContent = new Date().toLocaleString();
    
    // Initialize mock environment
    window.perkieEffects = new Map();
    
    function logResult(test, success, message, time) {
      testResults.push({ test, success, message, time: time || new Date() });
      updateResults();
    }
    
    function updateResults() {
      const container = document.getElementById('results');
      const passed = testResults.filter(r => r.success).length;
      const total = testResults.length;
      const percentage = total > 0 ? Math.round((passed / total) * 100) : 0;
      
      document.getElementById('progress').style.width = percentage + '%';
      document.getElementById('progress').textContent = percentage + '%';
      
      container.innerHTML = testResults.map(r => `
        <div class="test-item">
          <span class="test-icon">${r.success ? '‚úÖ' : '‚ùå'}</span>
          <span class="test-description">${r.test}: ${r.message}</span>
          <span class="test-time">${r.time.toLocaleTimeString()}</span>
        </div>
      `).join('');
    }
    
    function testUploadAndProcess() {
      const fileInput = document.getElementById('test-file');
      const statusDiv = document.getElementById('upload-status');
      
      if (!fileInput.files[0]) {
        statusDiv.innerHTML = '<div class="status error">Please select a file first</div>';
        return;
      }
      
      testFile = fileInput.files[0];
      currentSessionKey = 'test_' + Date.now();
      
      statusDiv.innerHTML = '<div class="status info">Processing file...</div>';
      
      // Simulate file processing
      const reader = new FileReader();
      reader.onload = function(e) {
        // Store original
        window.perkieEffects.set(currentSessionKey + '_original', e.target.result);
        
        // Store metadata
        window.perkieEffects.set(currentSessionKey + '_metadata', {
          filename: testFile.name,
          timestamp: new Date().toISOString(),
          artistNotes: ''
        });
        
        // Simulate API processing for different effects
        const effects = ['enhancedblackwhite', 'popart', 'dithering', 'color'];
        effects.forEach(effect => {
          // Simulate processed image (in real scenario, this would come from API)
          window.perkieEffects.set(currentSessionKey + '_' + effect, e.target.result);
        });
        
        statusDiv.innerHTML = '<div class="status success">‚úÖ File uploaded and processed successfully</div>';
        logResult('File Upload', true, 'File processed with all effects');
        
        // Enable next tests
        document.getElementById('effect-btn').disabled = false;
        document.getElementById('name-btn').disabled = false;
        document.getElementById('notes-btn').disabled = false;
        document.getElementById('cart-btn').disabled = false;
        document.getElementById('persist-btn').disabled = false;
        
        // Dispatch completion event
        document.dispatchEvent(new CustomEvent('petProcessorComplete', {
          detail: {
            sessionKey: currentSessionKey,
            effects: effects,
            originalDataUrl: e.target.result
          }
        }));
      };
      
      reader.readAsDataURL(testFile);
    }
    
    function testEffectSwitching() {
      const statusDiv = document.getElementById('effect-status');
      const effects = ['enhancedblackwhite', 'popart', 'dithering', 'color'];
      let errors = [];
      
      statusDiv.innerHTML = '<div class="status info">Testing effect switching...</div>';
      
      effects.forEach(effect => {
        const effectKey = currentSessionKey + '_' + effect;
        const imageUrl = window.perkieEffects.get(effectKey);
        
        if (!imageUrl) {
          errors.push(`Missing image for effect: ${effect}`);
        } else if (!imageUrl.startsWith('data:')) {
          errors.push(`Invalid URL format for effect: ${effect}`);
        }
      });
      
      if (errors.length === 0) {
        statusDiv.innerHTML = '<div class="status success">‚úÖ All effects switch correctly</div>';
        logResult('Effect Switching', true, 'All 4 effects available and valid');
      } else {
        statusDiv.innerHTML = '<div class="status error">‚ùå ' + errors.join(', ') + '</div>';
        logResult('Effect Switching', false, errors.join(', '));
      }
    }
    
    function testPetNameCapture() {
      const statusDiv = document.getElementById('name-status');
      
      // Simulate pet name capture
      const petName = prompt('Enter pet name (testing):', 'Max');
      
      if (petName) {
        // Update metadata
        const metadata = window.perkieEffects.get(currentSessionKey + '_metadata');
        metadata.petName = petName;
        window.perkieEffects.set(currentSessionKey + '_metadata', metadata);
        
        statusDiv.innerHTML = `<div class="status success">‚úÖ Pet name captured: "${petName}"</div>`;
        logResult('Pet Name Capture', true, `Name saved: ${petName}`);
      } else {
        statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Pet name skipped</div>';
        logResult('Pet Name Capture', true, 'Skip functionality works');
      }
    }
    
    function testArtistNotes() {
      const statusDiv = document.getElementById('notes-status');
      
      // Simulate artist notes
      const notes = prompt('Enter artist notes (testing):', 'Please make the background blue');
      
      const metadata = window.perkieEffects.get(currentSessionKey + '_metadata');
      metadata.artistNotes = notes || '';
      window.perkieEffects.set(currentSessionKey + '_metadata', metadata);
      
      statusDiv.innerHTML = `<div class="status success">‚úÖ Artist notes saved: "${notes || '(empty)'}"</div>`;
      logResult('Artist Notes', true, `Notes saved: ${notes || '(empty)'}`);
    }
    
    function testCartIntegration() {
      const statusDiv = document.getElementById('cart-status');
      const metadata = window.perkieEffects.get(currentSessionKey + '_metadata');
      
      // Simulate cart properties
      const cartProperties = {
        '_pet_name': metadata.petName || '',
        '_session_id': currentSessionKey,
        '_effect_applied': 'enhancedblackwhite',
        '_image_filename': metadata.filename,
        '_editing_timestamp': metadata.timestamp,
        '_artist_notes': metadata.artistNotes || '',
        '_original_ref': currentSessionKey + '_original',
        '_processed_ref': currentSessionKey + '_enhancedblackwhite',
        '_has_custom_pet': 'true'
      };
      
      // Check all properties are under 255 chars
      let errors = [];
      Object.entries(cartProperties).forEach(([key, value]) => {
        if (value && value.length > 255) {
          errors.push(`${key} exceeds 255 char limit (${value.length} chars)`);
        }
      });
      
      if (errors.length === 0) {
        statusDiv.innerHTML = '<div class="status success">‚úÖ All cart properties valid</div>';
        logResult('Cart Integration', true, 'All properties within limits');
      } else {
        statusDiv.innerHTML = '<div class="status error">‚ùå ' + errors.join(', ') + '</div>';
        logResult('Cart Integration', false, errors.join(', '));
      }
    }
    
    function testPersistence() {
      const statusDiv = document.getElementById('persist-status');
      
      try {
        // Save to localStorage
        const effectsData = {};
        window.perkieEffects.forEach((value, key) => {
          if (typeof value === 'string' || typeof value === 'object') {
            effectsData[key] = value;
          }
        });
        
        localStorage.setItem('perkieEffects_backup', JSON.stringify(effectsData));
        
        // Calculate size
        const dataSize = new Blob([JSON.stringify(effectsData)]).size;
        const sizeMB = (dataSize / (1024 * 1024)).toFixed(2);
        
        // Try to restore
        const restored = JSON.parse(localStorage.getItem('perkieEffects_backup'));
        const restoredKeys = Object.keys(restored);
        
        statusDiv.innerHTML = `<div class="status success">‚úÖ Persistence working (${sizeMB}MB, ${restoredKeys.length} keys)</div>`;
        logResult('Persistence', true, `Saved ${sizeMB}MB with ${restoredKeys.length} keys`);
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Persistence failed: ${error.message}</div>`;
        logResult('Persistence', false, error.message);
      }
    }
    
    function testColdStart() {
      const statusDiv = document.getElementById('cold-status');
      
      // Test cold start estimation logic
      const estimates = {
        desktop: { warm: 7, cold: 25 },
        mobile: {
          '4g': { warm: 9, cold: 27 },
          '3g': { warm: 12, cold: 30 },
          '2g': { warm: 15, cold: 33 }
        },
        peakHours: 3 // additional buffer
      };
      
      const currentHour = new Date().getHours();
      const isPeakHour = currentHour >= 9 && currentHour <= 17;
      
      const results = [];
      results.push(`Desktop: ${estimates.desktop.warm}s warm / ${estimates.desktop.cold}s cold`);
      results.push(`Mobile 4G: ${estimates.mobile['4g'].warm}s warm / ${estimates.mobile['4g'].cold}s cold`);
      results.push(`Peak hour buffer: ${isPeakHour ? 'Active (+3s)' : 'Inactive'}`);
      
      statusDiv.innerHTML = `<div class="status success">‚úÖ Cold start estimates:<br>${results.join('<br>')}</div>`;
      logResult('Cold Start', true, 'Estimation logic verified');
    }
    
    function inspectData() {
      const preview = document.getElementById('data-preview');
      const data = {
        sessionKey: currentSessionKey,
        localStorage: {
          perkieEffects_backup: localStorage.getItem('perkieEffects_backup') ? 
            JSON.parse(localStorage.getItem('perkieEffects_backup')) : null
        },
        perkieEffects: {}
      };
      
      window.perkieEffects.forEach((value, key) => {
        // Truncate data URLs for display
        if (typeof value === 'string' && value.startsWith('data:')) {
          data.perkieEffects[key] = value.substring(0, 50) + '...(truncated)';
        } else {
          data.perkieEffects[key] = value;
        }
      });
      
      preview.innerHTML = JSON.stringify(data, null, 2);
    }
  </script>
</body>
</html>