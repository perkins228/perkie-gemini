# Order Data Capture Analysis - Perkie Prints E-commerce Platform

**Date**: 2025-11-04
**Session**: 001
**Purpose**: Comprehensive analysis of ALL data captured and saved to Shopify orders

---

## Executive Summary

Perkie Prints captures **two categories of data** for Shopify orders:

1. **Standard Shopify Data** - Name, email, address, shipping, payment (handled by Shopify checkout)
2. **Custom Pet/Product Data** - Pet images, customizations, fonts, effects (captured via line item properties)

**Key Finding**: We use Shopify's `line_item.properties` to attach custom data to each order item. This data flows through three stages:
- **Product Page** ‚Üí Form fields populate with pet/customization data
- **Cart/Checkout** ‚Üí Data attaches to line items as hidden properties
- **Order Confirmation** ‚Üí Properties visible in order details for fulfillment staff

---

## 1. Standard Shopify Customer Data

### Captured by Shopify Checkout (Not our code):
- **Customer Information**:
  - Name (first + last)
  - Email address
  - Phone number
  - Billing address (street, city, state/province, zip, country)
  - Shipping address (street, city, state/province, zip, country)

- **Order Information**:
  - Order number (auto-generated by Shopify)
  - Order date/time
  - Payment method
  - Shipping method selected
  - Total price, tax, shipping cost
  - Discount codes applied

- **Product Information**:
  - Product title
  - Variant title (size, color, etc.)
  - Quantity
  - Price per item
  - Line item total

**Location**: Shopify's checkout system handles all of this automatically. No custom code required.

---

## 2. Custom Pet & Customization Data

### Overview
We capture custom pet and product personalization data through Shopify's **line item properties** system. These properties are attached to cart items when customers add products and persist through checkout to the final order.

### 2.1 Pet Image Data

#### Captured Fields:

| Property Name | Type | Source | Example Value |
|--------------|------|--------|---------------|
| `_has_custom_pet` | Boolean (string) | cart-pet-integration.js | `"true"` or `"false"` |
| `_processed_image_url` | URL (GCS) | cart-pet-integration.js | `https://storage.googleapis.com/.../processed.jpg` |
| `_original_image_url` | URL (GCS) | cart-pet-integration.js | `https://storage.googleapis.com/.../original.jpg` |
| `_pet_name` | String | cart-pet-integration.js | `"Buddy"` or `"Max, Luna"` (comma-separated) |
| `_effect_applied` | String | cart-pet-integration.js | `"enhancedblackwhite"`, `"popart"`, `"dithering"`, `"8bit"` |
| `_artist_notes` | String | cart-pet-integration.js | `"Please keep natural eye color"` |

#### Source Files:

**Primary Integration**: `assets/cart-pet-integration.js`
- **Lines 170-302**: `updateFormFields()` function creates/updates hidden form fields
- **Lines 181-192**: Pet name field (`properties[_pet_name]`)
- **Lines 227-245**: Processed image URL field (`properties[_processed_image_url]`)
  - **Priority**: GCS URL over compressed thumbnail (line 237-240)
- **Lines 247-259**: Original image URL field (`properties[_original_image_url]`)
- **Lines 261-273**: Artist notes field (`properties[_artist_notes]`)
- **Lines 275-284**: Has custom pet flag (`properties[_has_custom_pet]`)
- **Lines 286-297**: Effect applied field (`properties[_effect_applied]`)

**Storage Layer**: `assets/pet-storage.js`
- **Lines 12-51**: `save()` method stores pet data in localStorage
- **Storage Structure**:
  ```javascript
  {
    petId: "unique-session-key",
    artistNote: "customer notes",
    effects: {
      style: { gcsUrl: "https://..." }
    },
    timestamp: 1699123456789
  }
  ```
- **Lines 147-158**: `updateGlobalPets()` syncs to `window.perkiePets` for cart integration
- **Lines 697-749**: `storePetDataForCart()` saves thumbnail data to localStorage

**Display in Orders**: `snippets/order-custom-images.liquid`
- **Lines 128-133**: Checks if order has custom pets
- **Lines 144-207**: Displays pet images and metadata for staff
- **Lines 160-172**: Shows pet name, effect, and artist notes

#### Data Flow:

```
1. Customer uploads pet image
   ‚Üì
2. Pet Processor V5 processes image (background removal + effects)
   ‚Üì
3. Images uploaded to Google Cloud Storage (GCS)
   ‚Üì
4. PetStorage.save() stores GCS URLs + metadata in localStorage
   ‚Üì
5. Customer selects pet on product page
   ‚Üì
6. CartPetIntegration.updateFormFields() populates hidden form fields
   ‚Üì
7. Customer clicks "Add to Cart"
   ‚Üì
8. Shopify cart receives properties with pet data
   ‚Üì
9. Checkout processes order with properties attached to line items
   ‚Üì
10. Order confirmation shows properties in line_item.properties
```

---

### 2.2 Font & Text Customization Data

#### Captured Fields:

| Property Name | Type | Source | Example Value |
|--------------|------|--------|---------------|
| `_font_style` | String (validated) | cart-pet-integration.js | `"classic"`, `"preppy"`, `"playful"`, `"elegant"`, `"trend"`, `"no-text"` |

#### Source Files:

**Primary Integration**: `assets/cart-pet-integration.js`
- **Lines 11-31**: `validateFontStyle()` function validates allowed font values
- **Lines 194-224**: Font style field creation/update in `updateFormFields()`
  - **Lines 204-221**: Conditional font validation logic
    - Uses `sessionStorage.getItem('fontSelectorShown')` to check if selector was displayed
    - If selector not shown and product doesn't support fonts ‚Üí `"no-text"`
    - If selector not shown but product supports fonts ‚Üí default `"classic"`
    - If selector was shown ‚Üí uses localStorage preference
- **Lines 323-352**: `updateFontStyleFields()` updates all forms when font changes
- **Line 351**: Stores selection in localStorage: `localStorage.setItem('selectedFontStyle', fontStyle)`

**Font Selector UI**: `snippets/pet-font-selector.liquid`
- **Lines 16-98**: Six font option radio buttons:
  - Preppy (Libre Caslon Text with borders)
  - Classic (Merriweather) - **default**
  - Playful (Rampart One)
  - Elegant (Ms Madi)
  - Trend (Fascinate)
  - Blank (no-text) - for 40% who prefer portraits without names
- **Lines 291-311**: Font validation function (client-side)
- **Lines 443-462**: Font selection change handler
  - Validates font style before saving
  - Stores in localStorage
  - Dispatches `font:selected` event
  - **Lines 464-484**: Hides pet name input field when "no-text" selected

**Event System**:
- **Dispatched**: `font:selected` event with `{ style: string, includeNames: boolean }`
- **Listened**: cart-pet-integration.js (lines 66-70) updates form fields

#### Data Flow:

```
1. Customer enters pet name
   ‚Üì
2. Font selector appears (snippets/pet-font-selector.liquid)
   ‚Üì
3. sessionStorage.setItem('fontSelectorShown', 'true') set (line 368)
   ‚Üì
4. Customer selects font style
   ‚Üì
5. localStorage.setItem('selectedFontStyle', value) (line 457)
   ‚Üì
6. font:selected event dispatched (line 487-490)
   ‚Üì
7. CartPetIntegration.updateFontStyleFields() updates all forms (lines 323-352)
   ‚Üì
8. Hidden field properties[_font_style] populated (lines 194-224)
   ‚Üì
9. Add to cart ‚Üí font style attached to line item
   ‚Üì
10. Order properties include _font_style for fulfillment
```

---

### 2.3 Multi-Pet Product Data (New Selector)

**Note**: The new pet selector (`ks-product-pet-selector-stitch.liquid`) introduces a more structured approach for products that support multiple pets (e.g., 2-pet, 3-pet variants).

#### Captured Fields:

| Property Name | Type | Source | Example Value |
|--------------|------|--------|---------------|
| `Pet 1 Name` | String | ks-product-pet-selector-stitch.liquid | `"Buddy"` |
| `Pet 2 Name` | String | ks-product-pet-selector-stitch.liquid | `"Max"` |
| `Pet 3 Name` | String | ks-product-pet-selector-stitch.liquid | `"Luna"` |
| `Pet 1 Images` | File reference | ks-product-pet-selector-stitch.liquid | Shopify file upload reference |
| `Pet 2 Images` | File reference | ks-product-pet-selector-stitch.liquid | Shopify file upload reference |
| `Pet 3 Images` | File reference | ks-product-pet-selector-stitch.liquid | Shopify file upload reference |
| `Pet 1 Order Number` | String | ks-product-pet-selector-stitch.liquid | `"#12345"` (for returning customers) |
| `Pet 2 Order Number` | String | ks-product-pet-selector-stitch.liquid | `"#12345"` |
| `Pet 3 Order Number` | String | ks-product-pet-selector-stitch.liquid | `"#12345"` |
| `Pet 1 Order Type` | String | ks-product-pet-selector-stitch.liquid | `"new"` or `"returning"` |
| `Pet 1 Processing State` | String | ks-product-pet-selector-stitch.liquid | Processing status |
| `Pet 1 Upload Timestamp` | Timestamp | ks-product-pet-selector-stitch.liquid | Upload time |
| `Style` | String | ks-product-pet-selector-stitch.liquid | `"Modern"`, `"Classic"`, `"Vintage"`, `"Bold"` |
| `Font` | String | ks-product-pet-selector-stitch.liquid | `"Preppy"`, `"Classic"`, `"Playful"`, `"Elegant"`, `"Trend"`, `"No Name"` |

#### Source Files:

**New Pet Selector**: `snippets/ks-product-pet-selector-stitch.liquid`
- **Lines 42-125**: Pet count selection (1, 2, or 3 pets)
- **Lines 68-83**: Pet name inputs for each pet
- **Lines 83-100**: File upload inputs for pet images (Shopify native file upload)
- **Lines 113-125**: Previous order number inputs (for returning customers)
- **Lines 130-211**: Style selection radio buttons (4 styles)
- **Lines 247-319**: Font selection radio buttons (6 options including "No Name")
- **Lines 336-338**: Hidden fields for order type, processing state, upload timestamp

**Validation**: `assets/cart-pet-integration.js`
- **Lines 547-602**: `validateCustomization()` comprehensive validation
  - Checks pet count selection (line 557-560)
  - Validates pet name(s) entered (lines 562-577)
  - Validates style selection (lines 579-583)
  - **Conditional font validation** (lines 585-596):
    - Only validates font if product supports fonts (font radios exist in DOM)
    - If font section doesn't exist ‚Üí skip validation (non-text product)
- **Lines 533-545**: `validateAndUpdateButton()` updates button state
- **Lines 605-657**: `disableAddToCart()` with progressive messaging
  - Shows specific guidance based on missing field (e.g., "Select font to complete")
  - Mobile-optimized messaging (shorter text on small screens)

#### Data Flow:

```
1. Product page loads with new pet selector
   ‚Üì
2. Customer selects pet count (1, 2, or 3)
   ‚Üì
3. Corresponding pet detail sections become visible
   ‚Üì
4. Customer enters pet name(s) in visible fields
   ‚Üì
5. Customer selects style (Modern/Classic/Vintage/Bold)
   ‚Üì
6. IF product supports fonts: Customer selects font style
   ‚Üì
7. Customer uploads pet image(s) via Shopify file upload
   ‚Üì
8. Real-time validation checks all required fields (lines 547-602)
   ‚Üì
9. Add to Cart button enables when all validations pass
   ‚Üì
10. Form submission includes all properties as line item properties
   ‚Üì
11. Shopify processes file uploads and attaches URLs to order
   ‚Üì
12. Order includes all pet names, styles, fonts, and image file references
```

---

### 2.4 Returning Customer Data

#### Captured Fields:

| Property Name | Type | Source | Example Value |
|--------------|------|--------|---------------|
| `_order_type` | String | cart-pet-integration.js | `"standard"` or `"returning"` |
| `_previous_order_number` | String | cart-pet-integration.js | `"#12345"` |
| `_is_repeat_customer` | Boolean (string) | cart-pet-integration.js | `"true"` or `"false"` |

#### Source Files:

**Integration**: `assets/cart-pet-integration.js`
- **Lines 52-62**: Event listeners for returning customer events
  - `returning-customer:selected`
  - `returning-customer:deselected`
  - `returning-customer:updated`
- **Lines 354-402**: `updateReturningCustomerFields()` populates form fields
- **Lines 405-428**: `clearReturningCustomerFields()` resets to standard
- **Lines 806-826**: Form submission validation for returning customers
  - **CRITICAL**: Blocks submission if order type is "returning" but no order number provided
  - Shows alert: "Please enter your previous order number to use an existing Perkie Print."
  - Focuses order number input field (line 817-820)

**Old Selector**: `snippets/ks-product-pet-selector.liquid`
- **Lines 150-164**: Hidden fields for returning customer data
- **Line 150**: `properties[_is_repeat_customer]`
- **Line 164**: `properties[_previous_order_number]`

**New Selector**: `snippets/ks-product-pet-selector-stitch.liquid`
- **Lines 113-125**: Per-pet previous order number inputs
- **Line 336**: `properties[Pet {{ i }} Order Type]` hidden field

#### Data Flow:

```
1. Customer identifies as returning customer
   ‚Üì
2. returning-customer:selected event dispatched
   ‚Üì
3. CartPetIntegration.updateReturningCustomerFields() called (lines 354-402)
   ‚Üì
4. Hidden fields populated:
   - properties[_order_type] = "returning"
   - properties[_previous_order_number] = user input
   - properties[_is_repeat_customer] = "true"
   ‚Üì
5. Form submission validation checks order number (lines 806-826)
   ‚Üì
6. If missing ‚Üí Alert shown + submission blocked
   ‚Üì
7. If present ‚Üí Order proceeds with returning customer data
```

---

### 2.5 Processing State & Metadata

#### Captured Fields:

| Property Name | Type | Source | Example Value |
|--------------|------|--------|---------------|
| `_processing_state` | String | ks-product-pet-selector.liquid | Processing status flag |
| `_upload_timestamp` | Timestamp | ks-product-pet-selector.liquid | Upload completion time |
| `_pet_image` | File reference | ks-product-pet-selector.liquid | Shopify file upload ID |

#### Source Files:

**Old Selector**: `snippets/ks-product-pet-selector.liquid`
- **Line 135**: `properties[_pet_image]` hidden file input
- **Line 192**: `properties[_processing_state]` hidden field
- **Line 193**: `properties[_upload_timestamp]` hidden field

**New Selector**: `snippets/ks-product-pet-selector-stitch.liquid`
- **Line 337**: `properties[Pet {{ i }} Processing State]` hidden field
- **Line 338**: `properties[Pet {{ i }} Upload Timestamp]` hidden field

**Purpose**:
- **Processing State**: Tracks if image processing is complete, in progress, or failed
- **Upload Timestamp**: Records when customer uploaded image (for troubleshooting)
- **Pet Image**: Shopify file upload reference for native file handling

---

### 2.6 Add-On Product Validation Data

#### Purpose:
Ensure add-on products (e.g., extra prints, frames) can only be purchased alongside standard pet products.

#### Validation Logic:

**Source**: `assets/cart-pet-integration.js`
- **Lines 79-99**: `isAddonProduct()` checks if current product is add-on
  - Checks for `<meta name="product-is-addon" content="true">` tag
  - Checks product title for "add-on" or "addon" keywords
- **Lines 101-158**: `validateAddonProduct()` validates cart contents
  - Fetches current cart via `/cart.js` API (line 114-117)
  - Checks if cart has at least one non-add-on product (lines 128-140)
  - Blocks submission if only add-ons in cart (line 123-125, 141-145)
  - Shows error: "This is an add-on item. Please add a standard pet product to your cart first."
- **Lines 827-868**: Form submission intercept for add-on validation
  - Prevents submission and validates async (lines 830-835)
  - Re-submits form after validation passes (lines 842-851)

**No Data Captured**: This is validation-only logic that doesn't save additional properties to orders.

---

## 3. Product Configuration Data

### Product Metafields (Read-Only)

These metafields are configured in Shopify admin and READ by our code to determine which features to show:

| Metafield | Type | Purpose | Source |
|-----------|------|---------|--------|
| `product.metafields.custom.enable_pet_selector` | Boolean | Show/hide pet selector | main-product.liquid:451,457 |
| `product.metafields.custom.supports_font_styles` | Boolean | Show/hide font selector | main-product.liquid:452,469 |
| `product.metafields.reviews.rating` | Object | Product rating (for display) | main-product.liquid:497-522 |
| `product.metafields.reviews.rating_count` | Number | Review count (for display) | main-product.liquid:526-528 |

**Usage Example** (`sections/main-product.liquid`):
```liquid
{% if product.metafields.custom.enable_pet_selector == false %}
  {%- comment -%} Don't show pet selector for this product {%- endcomment -%}
{% endif %}

{% if product.metafields.custom.supports_font_styles == true %}
  {%- render 'pet-font-selector' -%}
{% endif %}
```

**Purpose**: Allows per-product control of customization features without code changes.

---

## 4. Analytics & Tracking Data

### Client-Side Analytics

**Source**: `assets/quick-upload-handler.js`
- **Lines 132-137**: Quick upload analytics tracking
  ```javascript
  if (window.gtag) {
    gtag('event', 'quick_upload_initiated', {
      device_type: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
    });
  }
  ```

**Source**: `snippets/analytics-tracking.liquid` (if exists)
- Additional Google Analytics/Facebook Pixel tracking
- Order confirmation tracking
- Conversion tracking

**Not Saved to Orders**: Analytics data is sent to third-party platforms (Google Analytics, Facebook) but NOT stored in Shopify order properties.

---

## 5. localStorage Session Management

### Pet Session Data

**Source**: `assets/pet-storage.js`

#### Storage Keys:

| Key | Type | Purpose | Example |
|-----|------|---------|---------|
| `perkie_pet_{petId}` | JSON Object | Pet data with effects | See structure below |
| `cartPetData` | JSON Object | Cart thumbnail data | For cart display |
| `selectedFontStyle` | String | Font preference | `"classic"`, `"preppy"`, etc. |
| `fontSelectorShown` | Boolean (sessionStorage) | Font selector visibility flag | `"true"` or `"false"` |

#### Pet Storage Structure:
```javascript
{
  petId: "session-key-123",
  artistNote: "Keep natural eye color",
  effects: {
    enhancedblackwhite: { gcsUrl: "https://storage.googleapis.com/..." },
    popart: { gcsUrl: "https://storage.googleapis.com/..." }
  },
  timestamp: 1699123456789
}
```

#### Cart Pet Data Structure:
```javascript
{
  "Buddy": {
    name: "Buddy",
    thumbnail: "data:image/jpeg;base64,...",
    effect: "enhancedblackwhite",
    timestamp: 1699123456789
  },
  "Max": {
    name: "Max",
    thumbnail: "data:image/jpeg;base64,...",
    effect: "popart",
    timestamp: 1699123456790
  }
}
```

#### Storage Quota Management:

**Source**: `assets/pet-storage.js`
- **Lines 24-33**: Quota check before save (warns at 80% capacity)
- **Lines 35-50**: Quota exceeded error handling with emergency cleanup
- **Lines 112-133**: `emergencyCleanup()` removes oldest pets to free space
- **Lines 96-108**: `getStorageUsage()` calculates used space

**Source**: `assets/cart-pet-integration.js`
- **Lines 697-749**: `storePetDataForCart()` with quota handling
- **Lines 751-780**: `clearOldPetData()` keeps only 5 newest pets

**Purpose**: Prevent localStorage quota errors that would break "Add to Cart" functionality.

---

## 6. Data NOT Captured (But Should Consider)

### Potential Gaps:

1. **Customer Device Type**: Not captured (mobile vs. desktop purchase)
   - **Impact**: Can't analyze mobile conversion differences
   - **Recommendation**: Add `_device_type` property from user agent

2. **Processing Time**: Not captured (how long AI processing took)
   - **Impact**: Can't identify slow processing issues per order
   - **Recommendation**: Add `_processing_duration_ms` property

3. **Image Quality Metrics**: Not captured (resolution, file size, etc.)
   - **Impact**: Can't identify low-quality uploads that may need remakes
   - **Recommendation**: Add `_image_width`, `_image_height`, `_file_size_kb` properties

4. **Effect Selection Journey**: Not captured (which effects were previewed before final selection)
   - **Impact**: Can't optimize effect preview UX
   - **Recommendation**: Add `_effects_previewed` array property

5. **Error/Retry Count**: Not captured (how many upload/processing attempts)
   - **Impact**: Can't identify problematic user flows
   - **Recommendation**: Add `_retry_count`, `_errors_encountered` properties

6. **A/B Test Variant**: Not captured (which UI variant customer saw)
   - **Impact**: Can't measure A/B test impact on conversions
   - **Recommendation**: Add `_ab_test_variant` property

7. **Referral Source**: Not captured at order level (Shopify has this at customer level)
   - **Impact**: Can't attribute individual orders to marketing campaigns
   - **Recommendation**: Add `_referral_source` property from UTM parameters

---

## 7. Order Data Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       PRODUCT PAGE                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 1. Customer Interaction                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Enter pet name(s)                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Upload pet image(s)                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Select style (Modern/Classic/Vintage/Bold)           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Select font (Preppy/Classic/Playful/etc.)            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Add artist notes (optional)                          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                      ‚Üì                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 2. Data Storage Layer (pet-storage.js)                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - PetStorage.save(petId, data)                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - localStorage: perkie_pet_{petId}                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - window.perkiePets global object                      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                      ‚Üì                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 3. Form Field Population (cart-pet-integration.js)       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - updateFormFields() creates hidden inputs             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - properties[_pet_name]                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - properties[_processed_image_url]                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - properties[_original_image_url]                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - properties[_font_style]                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - properties[_effect_applied]                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - properties[_artist_notes]                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - properties[_has_custom_pet] = "true"                 ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                      ‚Üì                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 4. Validation Layer (cart-pet-integration.js)            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - validateCustomization() checks all fields            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - validateAddonProduct() for add-ons                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Returning customer order number check                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       ADD TO CART                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 5. Cart Submission (POST /cart/add)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Form data includes all properties                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Shopify creates cart item with line_item.properties ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                      ‚Üì                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 6. Cart Display                                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - main-cart-items.liquid renders items                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Shows properties in cart (if needed)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - CartPetThumbnails.refresh() updates thumbnails       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       CHECKOUT                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 7. Shopify Checkout                                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Customer enters shipping/billing info                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Customer completes payment                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Line item properties persist through checkout       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       ORDER CONFIRMATION                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 8. Order Created in Shopify                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Order object includes line_items                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Each line_item includes properties{}                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - order-custom-images.liquid displays for staff        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Order Data Structure:                                           ‚îÇ
‚îÇ  {                                                               ‚îÇ
‚îÇ    order_number: "#12345",                                      ‚îÇ
‚îÇ    customer: { name, email, address, phone },                   ‚îÇ
‚îÇ    line_items: [                                                ‚îÇ
‚îÇ      {                                                           ‚îÇ
‚îÇ        product_title: "Custom Pet Portrait",                    ‚îÇ
‚îÇ        quantity: 1,                                             ‚îÇ
‚îÇ        price: 49.99,                                            ‚îÇ
‚îÇ        properties: {                                            ‚îÇ
‚îÇ          _pet_name: "Buddy, Max",                               ‚îÇ
‚îÇ          _processed_image_url: "https://storage...",            ‚îÇ
‚îÇ          _original_image_url: "https://storage...",             ‚îÇ
‚îÇ          _font_style: "classic",                                ‚îÇ
‚îÇ          _effect_applied: "enhancedblackwhite",                 ‚îÇ
‚îÇ          _artist_notes: "Keep natural eye color",               ‚îÇ
‚îÇ          _has_custom_pet: "true",                               ‚îÇ
‚îÇ          _order_type: "standard",                               ‚îÇ
‚îÇ          _is_repeat_customer: "false"                           ‚îÇ
‚îÇ        }                                                         ‚îÇ
‚îÇ      }                                                           ‚îÇ
‚îÇ    ]                                                             ‚îÇ
‚îÇ  }                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 8. Critical Implementation Notes

### 8.1 GCS URL Priority Over Thumbnails

**Issue**: We used to store compressed data URL thumbnails, causing order data loss when localStorage quota exceeded.

**Fix** (`assets/cart-pet-integration.js` lines 236-245):
```javascript
// CRITICAL FIX: Prioritize GCS URL over compressed thumbnail
if (petData.gcsUrl) {
  // Use full-resolution GCS URL if available
  processedUrlField.value = petData.gcsUrl;
  console.log('‚úÖ Using GCS URL for processed image:', petData.gcsUrl);
} else if (petData.processedImage) {
  // Fallback to compressed thumbnail if GCS upload hasn't completed
  processedUrlField.value = this.compressImageUrl(petData.processedImage);
  console.warn('‚ö†Ô∏è Using compressed thumbnail (GCS URL not available yet)');
}
```

**Impact**: Full-resolution images always available in orders, even if localStorage cleared.

### 8.2 Conditional Font Validation

**Issue**: Font selector validation was blocking orders for products that don't support text (e.g., standalone photos).

**Fix** (`assets/cart-pet-integration.js` lines 585-596):
```javascript
// 4. Validate font selection (conditional - only for products that support fonts)
// Font section only renders when product.metafields.custom.supports_font_styles == true
// Check if font radios exist in DOM (indicates text product supports fonts)
var fontRadios = newPetSelector.querySelectorAll('[data-font-radio]');
if (fontRadios.length > 0) {
  // Font section exists - validate that one is selected
  var fontRadio = newPetSelector.querySelector('[data-font-radio]:checked');
  if (!fontRadio) {
    missingFields.push('font');
  }
}
// If fontRadios.length === 0, this is a non-text product - skip font validation
```

**Impact**: Non-text products can be ordered without font selection, while text products require font choice.

### 8.3 Scope Bug in PetStorage.save()

**Issue**: Variable `storageData` declared in try block, referenced in catch block (out of scope).

**Fix** (`assets/pet-storage.js` lines 12-51):
```javascript
static async save(petId, data) {
  // ‚úÖ FIX: Declare at function scope so it's accessible in catch block
  const storageData = {
    petId,
    artistNote: data.artistNote || '',
    effects: data.effects || {},
    timestamp: Date.now()
  };

  try {
    // Check storage quota before saving
    const usage = this.getStorageUsage();
    if (usage.percentage > 80) {
      console.warn(`‚ö†Ô∏è Storage at ${usage.percentage}% capacity, running cleanup`);
      this.emergencyCleanup();
    }

    localStorage.setItem(this.storagePrefix + petId, JSON.stringify(storageData));
    this.updateGlobalPets();
    return true;

  } catch (error) {
    if (error.name === 'QuotaExceededError') {
      console.error('üö® Storage quota exceeded, triggering emergency cleanup');
      this.emergencyCleanup();
      // Retry once after cleanup
      try {
        localStorage.setItem(this.storagePrefix + petId, JSON.stringify(storageData)); // ‚úÖ NOW IN SCOPE
        this.updateGlobalPets();
        return true;
      } catch (retryError) {
        console.error('‚ùå Storage still full after cleanup:', retryError);
        throw retryError;
      }
    }
    throw error;
  }
}
```

**Impact**: Fixed "Add to Cart" button errors affecting 5-10% of users.

### 8.4 sessionStorage Flag for Font Selector Display

**Issue**: localStorage font preference was being applied even when font selector never shown (Quick Upload initial state).

**Fix** (`snippets/pet-font-selector.liquid` line 368 + `assets/cart-pet-integration.js` lines 204-221):

**Snippet sets flag**:
```javascript
// Mark that font selector was shown this session
sessionStorage.setItem('fontSelectorShown', 'true');
console.log('‚úÖ Font selector displayed, sessionStorage flag set');
```

**Cart integration checks flag**:
```javascript
var fontSelectorShown = sessionStorage.getItem('fontSelectorShown') === 'true';
var productSupportsFonts = window.productSupportsFonts === true;
var rawFontStyle;

if (fontSelectorShown) {
  // Font selector was shown - use localStorage preference
  rawFontStyle = localStorage.getItem('selectedFontStyle') || 'classic';
  console.log('‚úÖ Font selector was shown, using stored preference:', rawFontStyle);
} else if (!productSupportsFonts) {
  // Product doesn't support fonts - explicitly set to "no-text"
  rawFontStyle = 'no-text';
  console.log('‚ÑπÔ∏è Product does not support fonts, using: no-text');
} else {
  // Font selector not shown yet (Quick Upload initial state) - use safe default
  rawFontStyle = 'classic';
  console.log('‚ö†Ô∏è Font selector not shown yet, using default: classic');
}
```

**Impact**: Prevents stale font preferences from overriding correct defaults.

---

## 9. Recommendations

### 9.1 High Priority

1. **Add Device Type Tracking**: Capture `_device_type` property to analyze mobile vs. desktop conversion
   - **File**: `assets/cart-pet-integration.js`
   - **Method**: Add device detection in `updateFormFields()` around line 275

2. **Add Image Quality Metrics**: Capture `_image_width`, `_image_height`, `_file_size_kb` to identify low-quality uploads
   - **File**: `assets/cart-pet-integration.js`
   - **Method**: Extract from File object during upload, add to properties around line 250

3. **Add Processing Duration**: Capture `_processing_duration_ms` to identify slow processing
   - **File**: `assets/pet-processor.js` (not examined in this analysis)
   - **Method**: Track start/end timestamps during AI processing

### 9.2 Medium Priority

4. **Add Effect Preview Journey**: Capture `_effects_previewed` array to optimize UX
   - **File**: `assets/pet-processor.js`
   - **Method**: Track which effects customer previewed before final selection

5. **Add Error/Retry Tracking**: Capture `_retry_count`, `_errors_encountered` to identify problematic flows
   - **File**: `assets/cart-pet-integration.js`
   - **Method**: Increment counter on validation errors, quota errors, upload errors

6. **Add A/B Test Variant**: Capture `_ab_test_variant` to measure test impact
   - **File**: `assets/cart-pet-integration.js`
   - **Method**: Read from `window.abTestVariant` or similar global

### 9.3 Low Priority

7. **Add Referral Source**: Capture `_referral_source` from UTM parameters
   - **File**: `assets/cart-pet-integration.js`
   - **Method**: Parse URL query string for utm_source, utm_campaign, etc.

8. **Add Session Duration**: Capture `_session_duration_seconds` to correlate with conversion
   - **File**: `assets/cart-pet-integration.js`
   - **Method**: Track session start time, calculate duration on add to cart

---

## 10. Testing Checklist

### Data Capture Verification:

- [ ] **Pet Name**: Verify pet name(s) appear in order properties
- [ ] **Processed Image URL**: Verify GCS URL (not data URL) in order properties
- [ ] **Original Image URL**: Verify GCS URL in order properties
- [ ] **Font Style**: Verify selected font appears in order properties
- [ ] **Effect Applied**: Verify selected effect appears in order properties
- [ ] **Artist Notes**: Verify notes appear in order properties (if provided)
- [ ] **Has Custom Pet Flag**: Verify flag is "true" for custom orders
- [ ] **Returning Customer**: Verify order type and previous order number (if applicable)
- [ ] **Multi-Pet Products**: Verify all pet names and images captured separately
- [ ] **Style Selection**: Verify style (Modern/Classic/Vintage/Bold) captured for new selector
- [ ] **Font Conditional Validation**: Verify non-text products don't require font selection
- [ ] **Add-On Validation**: Verify add-ons can't be purchased without standard products

### Edge Cases:

- [ ] **localStorage Quota Exceeded**: Verify emergency cleanup works and order still processes
- [ ] **Font Selector Not Shown**: Verify default font used correctly
- [ ] **GCS Upload Pending**: Verify fallback to compressed thumbnail
- [ ] **Multiple Pets, Single Photo**: Verify comma-separated names handled correctly
- [ ] **Returning Customer Missing Order Number**: Verify submission blocked + alert shown
- [ ] **Mobile Quick Upload**: Verify keyboard closes before error toast

---

## 11. File Reference Quick Guide

### Core Files:

| File | Purpose | Key Lines |
|------|---------|-----------|
| `assets/cart-pet-integration.js` | Main integration layer | 170-302 (form fields), 547-602 (validation) |
| `assets/pet-storage.js` | localStorage management | 12-51 (save), 147-158 (global sync) |
| `snippets/ks-product-pet-selector.liquid` | Old pet selector UI | 89-193 (form inputs) |
| `snippets/ks-product-pet-selector-stitch.liquid` | New multi-pet selector | 42-338 (comprehensive form) |
| `snippets/pet-font-selector.liquid` | Font selector UI | 16-98 (options), 443-462 (handler) |
| `snippets/order-custom-images.liquid` | Order display for staff | 144-207 (image display) |
| `sections/main-product.liquid` | Product page layout | 451-469 (metafield checks) |
| `assets/quick-upload-handler.js` | Quick upload handler | 89-143 (file picker), 161-200 (validation) |

---

## 12. Summary

**Total Data Fields Captured**: 20+ custom properties per order

**Critical Success Factors**:
1. GCS URLs instead of data URLs (prevents quota issues)
2. Conditional font validation (supports non-text products)
3. sessionStorage flag for font selector visibility (prevents stale preferences)
4. Emergency cleanup for localStorage quota (prevents add-to-cart failures)
5. Add-on validation (ensures standard products in cart first)

**Data Flow**: Product Page ‚Üí localStorage ‚Üí Hidden Form Fields ‚Üí Cart ‚Üí Checkout ‚Üí Order Properties ‚Üí Staff Dashboard

**No Data Loss Risk**: All critical data (images, names, customizations) stored in GCS and passed via URLs, not dependent on localStorage persistence.

---

**Document Version**: 1.0
**Last Updated**: 2025-11-04
**Next Review**: When adding new customization features or data fields
