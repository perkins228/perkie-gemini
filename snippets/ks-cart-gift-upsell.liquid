{% if settings.cart_gift_upsell_show and settings.cart_gift_upsell_product != blank %}
  {% liquid
    assign product = settings.cart_gift_upsell_product
    assign is_in_cart = false

    for line_item in cart.items
      if line_item.product.handle == product.handle
        assign is_in_cart = true
      endif
    endfor
  %}

  {% unless is_in_cart %}
    <details class="ks-cart-gift-upsell">
      <summary onclick="ksCartDrawerFixScrollPosition(this)">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          class="ks-svg-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
        </svg>
        <span class="summary__title">
          {{ settings.cart_gift_upsell_heading }}
          {{- 'icon-caret.svg' | inline_asset_content -}}
        </span>
      </summary>
      <div class="details-inner">
        <div class="ks-cart-upsell-item">
          <div class="ks-cart-upsell-item-image">
            <a href="{{ product.url }}" tabindex="-1">
              <img
                src="{{ product.featured_image | image_url: width: 300 }}"
                class="img-fluid d-block"
                alt="{{ product.featured_image.alt | escape }}"
                width="150"
                height="{{ 150 | divided_by: product.featured_image.aspect_ratio | ceil }}"
                loading="lazy"
              >
            </a>
          </div>
          <div class="ks-cart-upsell-item-details">
            <div class="rte description">
              {% assign price = product.price | money %}
              {{ settings.cart_gift_upsell_description | replace: '[price]', price }}
            </div>
            <product-form data-section-id="{{ section.id }}">
              {%- form 'product', product, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                {% if product.has_only_default_variant %}
                  <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                {% else %}
                  <div class="field-wrapper">
                    <div class="select">
                      <select
                        id="ks-cart-drawer-upsell-selector-{{ forloop.index }}"
                        name="id"
                        class="select__select"
                        aria-label="Select variant"
                      >
                        {% for variant in product.variants %}
                          <option
                            value="{{ variant.id }}"
                            data-variant-img="{% if variant.image %}{{ variant.image | image_url: width: 300 }}{% endif %}"
                            {% if variant.available == false %}
                              disabled
                            {% endif %}
                          >
                            {{ variant.title }} -
                            {% if variant.available == false %}
                              {{ 'products.product.sold_out' | t }}
                            {% else %}
                              {{ variant.price | money }}
                            {% endif %}
                          </option>
                        {% endfor %}
                      </select>
                      <span class="svg-wrapper">
                        {{- 'icon-caret.svg' | inline_asset_content -}}
                      </span>
                    </div>
                  </div>
                {% endif %}
                <button
                  type="submit"
                  name="add"
                  class="button button--full-width {{ settings.cart_gift_upsell_btn_style }}"
                >
                  <span>{{ 'products.product.add_to_cart' | t }}</span>
                  {%- render 'loading-spinner' -%}
                </button>
              {% endform %}
            </product-form>
          </div>
        </div>
      </div>
    </details>
  {% endunless %}
{% endif %}
