var EffectsV2;(()=>{"use strict";var e={d:(t,a)=>{for(var i in a)e.o(a,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:a[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>c});const a=new class{constructor(){this.baseUrl="https://gemini-artistic-api-3km6z2qpyq-uc.a.run.app",this.cache=new Map,this.pending=new Map,this.maxRetries=2,this.timeout=6e4,this.rateLimitKey="gemini_artistic_rate_limit",this.maxRequestsPerDay=5}checkRateLimit(){const e=localStorage.getItem(this.rateLimitKey),t=new Date;if(!e)return{allowed:!0,remaining:this.maxRequestsPerDay-1,resetTime:this.getNextResetTime(t)};const a=JSON.parse(e),i=new Date(a.resetTime);return t>=i?{allowed:!0,remaining:this.maxRequestsPerDay-1,resetTime:this.getNextResetTime(t)}:a.count>=this.maxRequestsPerDay?{allowed:!1,remaining:0,resetTime:i}:{allowed:!0,remaining:this.maxRequestsPerDay-a.count-1,resetTime:i}}getNextResetTime(e){const t=new Date(e);return t.setDate(t.getDate()+1),t.setHours(0,0,0,0),t}incrementRateLimit(){const e=localStorage.getItem(this.rateLimitKey),t=new Date;if(!e)return void localStorage.setItem(this.rateLimitKey,JSON.stringify({count:1,resetTime:this.getNextResetTime(t).toISOString()}));const a=JSON.parse(e);t>=new Date(a.resetTime)?localStorage.setItem(this.rateLimitKey,JSON.stringify({count:1,resetTime:this.getNextResetTime(t).toISOString()})):(a.count++,localStorage.setItem(this.rateLimitKey,JSON.stringify(a)))}async applyStyle(e,t){const a=this.checkRateLimit();if(!a.allowed){const e=Math.ceil((a.resetTime-new Date)/36e5);throw new Error(`Rate limit exceeded. You have used all ${this.maxRequestsPerDay} Modern/Classic style requests today. Please try again in ${e} hours.`)}const i={modern:"ink_wash",classic:"van_gogh_post_impressionism"}[t];if(!i)throw new Error(`Invalid style: ${t}. Must be 'modern' or 'classic'.`);const s=new FormData;s.append("image",e,"pet.png"),s.append("style",i);try{const e=await this.request("/generate-artistic",{method:"POST",body:s,timeout:6e4});return this.incrementRateLimit(),e}catch(e){throw console.error("Gemini artistic style failed:",e),e}}async request(e,t={}){const a=`${this.baseUrl}${e}`,i=this.getCacheKey(a,t);if("GET"===t.method&&this.cache.has(i)){const e=this.cache.get(i);if(!this.isStale(e))return e.data}if(this.pending.has(i))return this.pending.get(i);const s=this.executeWithRetry(a,t);this.pending.set(i,s);try{const e=await s;return this.pending.delete(i),"GET"===t.method&&this.cache.set(i,{data:e,timestamp:Date.now()}),e}catch(e){throw this.pending.delete(i),e}}async executeWithRetry(e,t,a=1){try{const a=new AbortController,i=t.timeout||this.timeout,s=setTimeout(()=>{a.abort()},i),r=await fetch(e,{...t,signal:a.signal,mode:"cors",headers:{...t.headers}});if(clearTimeout(s),!r.ok){const e=await r.text();throw new Error(`Gemini API error ${r.status}: ${e}`)}const n=r.headers.get("content-type");return n&&n.includes("application/json")?await r.json():n&&n.startsWith("image/")?await r.blob():await r.text()}catch(i){if(a<this.maxRetries&&this.isRetryableError(i))return console.warn(`Gemini API request failed (attempt ${a}/${this.maxRetries}), retrying...`,i.message),await this.delay(1e3*a),this.executeWithRetry(e,t,a+1);throw i}}isRetryableError(e){return"AbortError"===e.name||e.message.includes("NetworkError")||e.message.includes("500")||e.message.includes("502")||e.message.includes("503")||e.message.includes("504")}getCacheKey(e,t){return`${t.method||"GET"}:${e}`}isStale(e){return Date.now()-e.timestamp>36e5}delay(e){return new Promise(t=>setTimeout(t,e))}async healthCheck(){try{return await this.request("/health",{method:"GET",timeout:5e3})}catch(e){throw console.error("Gemini API health check failed:",e),e}}getAvailableStyles(){return[{id:"modern",name:"Modern",description:"Ink wash artistic style with soft, flowing brushstrokes",geminiStyle:"ink_wash"},{id:"classic",name:"Classic",description:"Van Gogh post-impressionism with bold colors and expressive strokes",geminiStyle:"van_gogh_post_impressionism"}]}clearRateLimit(){localStorage.removeItem(this.rateLimitKey),console.log("Rate limit cleared")}};class i{constructor(){this.canvas=null,this.ctx=null,this.worker=null,this.supportsWebP=this.checkWebPSupport(),this.effects={original:this.original.bind(this),color:this.original.bind(this),blackwhite:this.blackwhite.bind(this)},this.geminiEffects=["modern","classic"]}async apply(e,t,a=1){if(this.geminiEffects.includes(t))return await this.applyGeminiEffect(e,t);if(!this.effects[t])throw new Error(`Unknown effect: ${t}`);const i=await this.loadImage(e);console.log("ğŸ”§ Canvas processing:",t,i.width+"x"+i.height);const s=i.width,r=i.height;return this.canvas?this.resizeCanvas(s,r):this.initCanvas(s,r),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(i,0,0,s,r),console.log("ğŸ”„ Using API image directly - correct orientation preserved"),"original"!==t&&"color"!==t&&await this.effects[t](this.ctx,i),this.getOptimizedResult()}async applyGeminiEffect(e,t){console.log("ğŸ¨ Gemini processing:",t);try{const i=a.checkRateLimit();if(!i.allowed){const e=Math.ceil((i.resetTime-new Date)/36e5);throw new Error(`Rate limit exceeded. You've used all ${a.maxRequestsPerDay} ${t} requests today. Resets in ${e}h.`)}const s=await fetch(e),r=await s.blob(),n=await a.applyStyle(r,t),o=URL.createObjectURL(n);return console.log("âœ… Gemini effect applied:",t),o}catch(e){throw console.error("âŒ Gemini effect failed:",e),e}}initCanvas(e,t){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!0}),this.resizeCanvas(e,t)}resizeCanvas(e,t){const a=1024;if(e>a||t>a){const i=a/Math.max(e,t);e=Math.floor(e*i),t=Math.floor(t*i)}this.canvas.width=e,this.canvas.height=t}async loadImage(e){return new Promise((t,a)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{t(i)},i.onerror=a,i.src=e})}getRotatedDimensions(e,t,a){return a>=5&&a<=8?{width:t,height:e}:{width:e,height:t}}drawRotatedImage(e,t){const{width:a,height:i}=this.getRotatedDimensions(e.width,e.height,t);switch(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),t){case 2:this.ctx.translate(a,0),this.ctx.scale(-1,1);break;case 3:this.ctx.translate(a,i),this.ctx.rotate(Math.PI);break;case 4:this.ctx.translate(0,i),this.ctx.scale(1,-1);break;case 5:this.ctx.translate(0,i),this.ctx.rotate(-Math.PI/2),this.ctx.scale(-1,1);break;case 6:this.ctx.translate(i,0),this.ctx.rotate(Math.PI/2);break;case 7:this.ctx.translate(i,a),this.ctx.rotate(Math.PI/2),this.ctx.scale(-1,1);break;case 8:this.ctx.translate(0,a),this.ctx.rotate(-Math.PI/2)}this.ctx.drawImage(e,0,0,e.width,e.height),this.ctx.restore()}original(e,t){}blackwhite(e,t){const a=e.getImageData(0,0,this.canvas.width,this.canvas.height),i=a.data;for(let e=0;e<i.length;e+=4){const t=.299*i[e]+.587*i[e+1]+.114*i[e+2],a=this.enhanceContrast(t,1.2);i[e]=a,i[e+1]=a,i[e+2]=a}e.putImageData(a,0,0)}enhanceContrast(e,t){return 255*((e/255-.5)*t+.5)}async getOptimizedResult(){const e=this.supportsWebP?"webp":"png";return new Promise(t=>{this.canvas.toBlob(e=>{t(URL.createObjectURL(e))},`image/${e}`,.85)})}checkWebPSupport(){const e=document.createElement("canvas");e.width=1,e.height=1;const t=e.getContext("2d");return t.fillStyle="#000",t.fillRect(0,0,1,1),5===e.toDataURL("image/webp").indexOf("image/webp")}async generateThumbnail(e,t=150){const a=await this.loadImage(e),i=document.createElement("canvas"),s=i.getContext("2d"),r=a.width/a.height;let n=t,o=t;return r>1?o=t/r:n=t*r,i.width=n,i.height=o,s.drawImage(a,0,0,n,o),i.toDataURL("image/webp",.7)}async generatePreviews(e,t=["original","blackwhite","modern","classic"]){const a=new Map;for(const i of t)try{const t=await this.apply(e,i),s=await this.generateThumbnail(t,150);a.set(i,{full:t,thumbnail:s})}catch(e){console.error(`Failed to generate preview for ${i}:`,e),this.geminiEffects.includes(i)&&a.set(i,{full:null,thumbnail:null,error:e.message})}return a}cleanup(){this.canvas&&(this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null),this.worker&&(this.worker.terminate(),this.worker=null)}}class s{constructor(){this.storagePrefix="perkie_pet_",this.apiUrl=null}setApiUrl(e){this.apiUrl=e}async compressThumbnail(e,t=200,a=.6){return new Promise(i=>{const s=new Image;s.onload=()=>{const e=document.createElement("canvas"),r=e.getContext("2d"),n=Math.min(t/s.width,t/s.height);e.width=s.width*n,e.height=s.height*n,r.fillStyle="#ffffff",r.fillRect(0,0,e.width,e.height),r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",r.drawImage(s,0,0,e.width,e.height);const o=e.toDataURL("image/jpeg",a),c=(.75*o.length/1024).toFixed(1);console.log(`ğŸ“¸ Compressed: ${s.width}x${s.height} â†’ ${e.width}x${e.height} (${c}KB)`),i(o)},s.onerror=()=>{console.warn("Failed to compress image, using original"),i(e)},s.src=e})}async save(e,t){let a;try{const i=t.thumbnail?await this.compressThumbnail(t.thumbnail,200,.6):"";a={petId:e,name:t.name||"Pet",filename:t.filename||"",thumbnail:i,gcsUrl:t.gcsUrl||"",originalUrl:t.originalUrl||"",artistNote:t.artistNote||"",effect:t.effect||"original",effects:t.effects||{},timestamp:Date.now()};const s=this.getStorageUsage();return s.percentage>80&&(console.warn(`âš ï¸ Storage at ${s.percentage}% capacity, running cleanup`),this.emergencyCleanup()),localStorage.setItem(this.storagePrefix+e,JSON.stringify(a)),this.updateGlobalPets(),!0}catch(t){if("QuotaExceededError"===t.name){console.error("ğŸš¨ Storage quota exceeded, triggering emergency cleanup"),this.emergencyCleanup();try{return localStorage.setItem(this.storagePrefix+e,JSON.stringify(a)),this.updateGlobalPets(),!0}catch(e){throw console.error("âŒ Storage still full after cleanup:",e),e}}throw t}}get(e){const t=localStorage.getItem(this.storagePrefix+e);return t?JSON.parse(t):null}getAll(){const e={};for(const t in localStorage)t.startsWith(this.storagePrefix)&&(e[t.replace(this.storagePrefix,"")]=JSON.parse(localStorage.getItem(t)));return e}delete(e){return localStorage.removeItem(this.storagePrefix+e),this.updateGlobalPets(),!0}clear(){Object.keys(localStorage).filter(e=>e.startsWith(this.storagePrefix)).forEach(e=>localStorage.removeItem(e)),this.updateGlobalPets()}getStorageUsage(){let e=0;for(const t in localStorage)t.startsWith(this.storagePrefix)&&(e+=localStorage.getItem(t).length);return{used:e,usedKB:(e/1024).toFixed(1),percentage:(e/5242880*100).toFixed(1)}}emergencyCleanup(){console.log("ğŸ§¹ Starting emergency storage cleanup");const e=this.getStorageUsage();console.log(`ğŸ“Š Before cleanup: ${e.usedKB}KB (${e.percentage}%)`);const t=this.getAll(),a=Object.entries(t).sort((e,t)=>e[1].timestamp-t[1].timestamp);let i=0;for(;this.getStorageUsage().percentage>50&&a.length>i;){const[e]=a[i];this.delete(e),i++,console.log(`ğŸ—‘ï¸ Removed old pet: ${e}`)}const s=this.getStorageUsage();console.log(`âœ… Cleanup complete: ${s.usedKB}KB (${s.percentage}%) - Removed ${i} pets`)}updateGlobalPets(){const e=this.getAll();window.perkiePets={pets:Object.values(e).map(e=>({sessionKey:e.petId,gcsUrl:e.gcsUrl,effect:e.effect,thumbnail:e.thumbnail,name:e.name}))}}async uploadToGCS(e,t,a,i="none"){if(!this.apiUrl)return console.error("âŒ API URL not set in StorageManager"),null;try{console.log(`ğŸ“¤ Uploading ${a} image to GCS...`);const s=await fetch(e),r=await s.blob(),n=new FormData;n.append("file",r,`${t}.jpg`),t&&n.append("session_key",t),i&&"none"!==i&&n.append("effect_applied",i);const o=`${this.apiUrl}/store-image`,c=await fetch(o,{method:"POST",body:n});if(!c.ok){const e=await c.text();return console.error(`âŒ Upload failed (${c.status}):`,e),null}const l=await c.json();return l.success&&l.url?(console.log(`âœ… ${a} uploaded:`,l.url),l.url):(console.error("âŒ Upload succeeded but no URL returned:",l),null)}catch(e){return console.error(`âŒ Error uploading ${a} image:`,e),null}}sanitizeName(e){return e?e.replace(/[<>"'&]/g,"").substring(0,50):"Pet"}}const r=new s;"undefined"!=typeof window&&(window.StorageManager=s,window.storageManager=r);class n{constructor(){this.watermarkConfig={text:"PerkiePrints.com",font:"italic 20px Georgia, serif",fillStyle:"rgba(255, 255, 255, 0.9)",strokeStyle:"rgba(0, 0, 0, 0.4)",lineWidth:2,padding:15}}async share(e,t={}){try{const a=await this.getCanvasFromSource(e);return a?(this.ensureWhiteBackground(a),this.addWatermark(a),navigator.share&&this.isMobile()?await this.shareViaNativeAPI(a,t):await this.shareViaClipboard(a)):(this.showToast("Failed to prepare image for sharing"),!1)}catch(e){return console.error("[Sharing Manager] Share failed:",e),this.showToast("Failed to share image"),!1}}async getCanvasFromSource(e){return e instanceof HTMLCanvasElement?e:e instanceof HTMLImageElement?this.createCanvasFromImage(e):"string"==typeof e&&e.startsWith("data:")?this.createCanvasFromDataUrl(e):(console.error("[Sharing Manager] Invalid source type:",e),null)}createCanvasFromImage(e){const t=document.createElement("canvas");t.width=e.naturalWidth||e.width,t.height=e.naturalHeight||e.height;const a=t.getContext("2d");return a.fillStyle="#FFFFFF",a.fillRect(0,0,t.width,t.height),a.drawImage(e,0,0),t}createCanvasFromDataUrl(e){return new Promise((t,a)=>{const i=new Image;i.onload=()=>t(this.createCanvasFromImage(i)),i.onerror=()=>a(new Error("Failed to load image")),i.src=e})}ensureWhiteBackground(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const a=t.getContext("2d");a.fillStyle="#FFFFFF",a.fillRect(0,0,t.width,t.height),a.drawImage(e,0,0);const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height),i.drawImage(t,0,0)}addWatermark(e){const t=e.getContext("2d"),a=this.watermarkConfig;t.save(),t.font=a.font,t.fillStyle=a.fillStyle,t.strokeStyle=a.strokeStyle,t.lineWidth=a.lineWidth;const i=a.text,s=t.measureText(i),r=e.width-s.width-a.padding,n=e.height-a.padding;t.strokeText(i,r,n),t.fillText(i,r,n),t.restore(),console.log("[Sharing Manager] Watermark added")}async shareViaNativeAPI(e,t={}){return new Promise(a=>{e.toBlob(async i=>{if(!i)return this.showToast("Failed to prepare image"),void a(!1);const s=new File([i],"my-pet.jpg",{type:"image/jpeg"});try{await navigator.share({files:[s],title:t.title||"Check out my pet!",text:t.text||"Created with PerkiePrints.com"}),console.log("[Sharing Manager] Shared successfully via native API"),this.trackShare("native"),a(!0)}catch(t){if("AbortError"!==t.name){console.error("[Sharing Manager] Native share failed:",t);const i=await this.shareViaClipboard(e);a(i)}else a(!1)}},"image/jpeg",.9)})}async shareViaClipboard(e){return new Promise(t=>{e.toBlob(async e=>{if(!e)return this.showToast("Failed to prepare image"),void t(!1);if(navigator.clipboard&&navigator.clipboard.write)try{const a=new ClipboardItem({"image/png":e});await navigator.clipboard.write([a]),this.showToast("Image copied! Paste directly into any social platform."),this.showPlatformInstructions(),this.trackShare("clipboard"),console.log("[Sharing Manager] Image copied to clipboard"),t(!0)}catch(a){console.error("[Sharing Manager] Clipboard API failed:",a),this.openImageInNewTab(e),t(!0)}else this.openImageInNewTab(e),t(!0)},"image/png",.9)})}openImageInNewTab(e){const t=URL.createObjectURL(e);window.open(t,"_blank")?(this.showToast("Image opened in new tab. Right-click to copy."),setTimeout(()=>{URL.revokeObjectURL(t)},6e4)):this.showToast("Please allow pop-ups to share the image."),this.trackShare("new-tab")}showToast(e){const t=document.createElement("div");t.className="pet-share-toast",t.textContent=e,t.style.cssText="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:12px 24px;border-radius:4px;z-index:9999;font-size:14px;",document.body.appendChild(t),setTimeout(()=>{t.style.transition="opacity 0.3s",t.style.opacity="0",setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},300)},3e3)}showPlatformInstructions(){const e=document.createElement("div");e.className="share-instructions-modal",e.innerHTML='<div class="instructions-content"><h4>Image Copied! Now paste it:</h4><div class="platform-list"><div class="platform-item">ğŸ“˜ <strong>Facebook:</strong> Create post â†’ Ctrl+V (Cmd+V on Mac)</div><div class="platform-item">ğŸ“· <strong>Instagram:</strong> Open web â†’ Create â†’ Ctrl+V</div><div class="platform-item">ğŸ“Œ <strong>Pinterest:</strong> Create Pin â†’ Ctrl+V</div><div class="platform-item">ğŸ¦ <strong>Twitter/X:</strong> Compose tweet â†’ Ctrl+V</div></div><button class="close-btn">Got it!</button></div>',e.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;",document.body.appendChild(e);const t=()=>{e&&e.parentNode&&e.parentNode.removeChild(e)};e.querySelector(".close-btn").addEventListener("click",t),e.addEventListener("click",a=>{a.target===e&&t()}),setTimeout(t,8e3)}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.matchMedia&&window.matchMedia("(max-width: 768px)").matches}trackShare(e){window.gtag&&window.gtag("event","share",{event_category:"engagement",event_label:e}),console.log("[Sharing Manager] Tracked share:",e)}}const o=new n;"undefined"!=typeof window&&(window.SharingManager=n,window.sharingManager=o);const c={EffectProcessor:i,geminiClient:a,StorageManager:s,storageManager:r,SharingManager:n,sharingManager:o};"undefined"!=typeof window&&(window.EffectsV2={EffectProcessor:i,geminiClient:a,StorageManager:s,storageManager:r,SharingManager:n,sharingManager:o},window.storageManager=r,window.sharingManager=o),EffectsV2=t.default})();
//# sourceMappingURL=effects-v2-bundle.js.map