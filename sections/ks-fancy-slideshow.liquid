{% liquid
  if section.settings.media_adapt == false
    assign media_mobile_height = section.settings.media_mobile_height | prepend: 'height: ' | append: 'px;'
    assign media_desktop_height = section.settings.media_desktop_height | prepend: 'height: ' | append: 'px;'
  endif
%}


{%- style -%}
  #ks-fancy-slideshow-{{ section.id }} {
    padding-top: {{ section.settings.pt | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.pb | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    #ks-fancy-slideshow-{{ section.id }} {
      padding-top: {{ section.settings.pt }}px;
      padding-bottom: {{ section.settings.pb }}px;
    }
  }
{%- endstyle -%}

<ks-fancy-slideshow
  id="ks-fancy-slideshow-{{ section.id }}" 
  class="ks-fancy-slideshow color-{{ section.settings.color_scheme }}"
  data-vendor-css-file="{{ 'ks-vendor-swiper.bundle.min.css' | asset_url }}"
  data-vendor-js-file="{{ 'ks-vendor-swiper.bundle.min.js' | asset_url }}">
  <div 
    class="swiper"
    data-swiper-navigation="{{ section.settings.slider_navigation }}"
    data-swiper-pagination="{{ section.settings.slider_pagination }}"
    data-swiper-effect="{{ section.settings.slider_effect }}"
    data-swiper-speed="{{ section.settings.slider_speed }}"
    data-swiper-autoplay="{{ section.settings.slider_autoplay }}"
    data-swiper-partial="{{ section.settings.slider_partial }}"
    data-swiper-spacing="{{ section.settings.slider_spacing }}"
    data-swiper-spacing-mobile="{{ settings.spacing_grid_horizontal | divided_by: 2 }}"
    data-swiper-spacing-desktop="{{ settings.spacing_grid_horizontal }}"
    style="--autoplay-time: {{ section.settings.slider_autoplay | times: 1000 | plus: section.settings.slider_speed }}ms; ">
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        {% liquid 
          if section.index > 1 or forloop.index > 1
            assign media_loading = 'lazy'
            assign video_autoplay = false
          else
            assign media_loading = 'eager'
            assign video_autoplay = true
          endif
        %}
        <div 
          class="swiper-slide" 
          data-index="{{ forloop.index0 }}"
          {{ block.shopify_attributes }}>
          <div 
            class="ks-media-wrapper"
            data-overlay-opacity="{{ block.settings.overlay_opacity }}"
            style="
              --overlay-color-rgb: {{ block.settings.overlay_color | color_to_rgb | remove: 'rgb(' | remove: ')' }};
              --overlay-opacity: {{ block.settings.overlay_opacity | append: '%' }};
              --overlay-blur: {{ block.settings.overlay_blur | append: 'px' }};
            ">
            {% if block.settings.video_mobile != blank or block.settings.video_desktop != blank %}
              <div class="d-desktop-none">
                {{-
                  block.settings.video_mobile | video_tag: 
                    class: 'ks-fancy-slideshow-media', 
                    style: media_mobile_height,
                    image_size: '800x', 
                    autoplay: video_autoplay, 
                    loop: true, 
                    muted: true, 
                    controls: false,
                    loading: media_loading,
                    preload: 'none',
                    data-autoplay: true
                -}}
              </div>
              <div class="d-none d-desktop-block">
                {{-
                  block.settings.video_desktop | video_tag: 
                    class: 'ks-fancy-slideshow-media', 
                    style: media_desktop_height,
                    image_size: '1600x', 
                    autoplay: video_autoplay, 
                    loop: true, 
                    muted: true, 
                    controls: false,
                    loading: media_loading,
                    preload: 'none',
                    data-autoplay: true
                -}}
              </div>
            {% elsif block.settings.img_mobile != blank or block.settings.img_desktop != blank %}
              <div class="d-desktop-none">
                <img 
                  class="ks-fancy-slideshow-media"
                  src="{{ block.settings.img_mobile | image_url: width: '800' }}" 
                  alt=" {{ block.settings.img_mobile.alt }}"
                  width="800"
                  height="{{ 800 | divided_by: block.settings.img_mobile.aspect_ratio | round }}"
                  loading="{{ media_loading }}"
                  style="{{ media_mobile_height }}">
              </div>
              <div class="d-none d-desktop-block">
                <img 
                  class="ks-fancy-slideshow-media"
                  src="{{ block.settings.img_desktop | image_url: width: '1600' }}" 
                  alt=" {{ block.settings.img_desktop.alt }}"
                  width="1600"
                  height="{{ 1600 | divided_by: block.settings.img_desktop.aspect_ratio | round }}"
                  loading="{{ media_loading }}"
                  style="{{ media_desktop_height }}">
              </div>
            {% else %}
              {% capture current %}{% cycle 1, 2 %}{% endcapture %}
              {{ 'lifestyle-' | append: current | placeholder_svg_tag: 'placeholder-svg' }}
            {% endif %}
          </div>
          <div 
            class="
              ks-fancy-slideshow-caption
              {{ block.settings.caption_text_align_mobile }} 
              {{ block.settings.caption_text_align_desktop }}
            "
            data-position-mobile="{{ block.settings.caption_position_mobile }}"
            data-position-desktop="{{ block.settings.caption_position_desktop }}">
            <div 
              class="ks-fancy-slideshow-caption-inner {% if settings.animations_reveal_on_scroll %}scroll-trigger{% endif %}" 
              style="max-width: {{ block.settings.caption_max_width | append: 'px' }};">
              {% render 'ks-section-content-block', block: block %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    <div class="swiper-pagination"></div>
    <div class="swiper-scrollbar"></div>
  </div>
</ks-fancy-slideshow>

{% if request.design_mode %}
  <script>
    document.addEventListener('shopify:block:select', (event) => {
      const section = event.target.closest('#ks-fancy-slideshow-{{ section.id }}')
    
      if (section) {
        const slider = section.querySelector('.swiper')
        slider.swiper.autoplay = false
        // slider.swiper.slideTo(event.target.dataset.index)
      }
    })
  </script>
{% endif %}
{% schema %}
{
  "name": "KS - Fancy slideshow",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Slider"
    },
    {
      "type": "checkbox",
      "id": "slider_navigation",
      "label": "Navigation (arrows)",
      "default": true
    },
    {
      "type": "select",
      "id": "slider_pagination",
      "label": "Pagination",
      "default": "bullets",
      "options": [
        { "value": "", "label": "None" },
        { "value": "bullets", "label": "Bullets" },
        { "value": "fraction", "label": "Fraction" },
        { "value": "scrollbar", "label": "Scrollbar" },
      ]
    },
    {
      "type": "select",
      "id": "slider_effect",
      "label": "Effect",
      "info": "NOTE: Some options work only if the \"Partial slides\" setting below is disabled",
      "default": "slide", 
      "options": [
        { "value": "slide", "label": "Slide" },
        { "value": "fade", "label": "Fade" },
        { "value": "cube", "label": "Cube" },
        { "value": "coverflow", "label": "Coverflow" },
        { "value": "flip", "label": "Flip" },
        { "value": "creative", "label": "Creative" }
      ]
    },
    {
      "type": "range",
      "id": "slider_speed",
      "label": "Speed",
      "default": 700,
      "min": 0,
      "max": 2000,
      "step": 100,
      "unit": "ms"
    },
    {
      "type": "range",
      "id": "slider_autoplay",
      "label": "Autoplay",
      "min": 0,
      "max": 10,
      "default": 5,
      "unit": "sec",
      "info": "Select \"0\" to disable autoplay"
    },
    {
      "type": "checkbox",
      "id": "slider_partial",
      "label": "Partial slides",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "slider_spacing",
      "label": "Space between slides",
      "default": true
    },
    {
      "type": "header",
      "content": "Media (Image/Video)"
    },
    {
      "type": "range",
      "id": "media_mobile_height",
      "label": "Mobile media height (px)",
      "min": 300,
      "max": 1000,
      "step": 10,
      "default": 400
    },
    {
      "type": "range",
      "id": "media_desktop_height",
      "label": "Desktop media height (px)",
      "min": 300,
      "max": 1000,
      "step": 10,
      "default": 700
    },
    {
      "type": "checkbox",
      "id": "media_adapt",
      "label": "Adapt media",
      "default": false,
      "info": "If this setting is enabled, the original media propotions will be used. Also, the two settings above will not have effect."
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "pt",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 36,
      "unit": "px",
    },
    {
      "type": "range",
      "id": "pb",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 36,
      "unit": "px",
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "header",
          "content": "Image"
        },
        {
          "type": "image_picker",
          "id": "img_mobile",
          "label": "Image - mobile"
        },
        {
          "type": "image_picker",
          "id": "img_desktop",
          "label": "Image - desktop"
        },
        {
          "type": "header",
          "content": "Video"
        },
        {
          "type": "video",
          "id": "video_mobile",
          "label": "Video - mobile"
        },
        {
          "type": "video",
          "id": "video_desktop",
          "label": "Video - desktop" 
        },
        {
          "type": "header",
          "content": "Overlay"
        },
        {
          "type": "color",
          "id": "overlay_color",
          "label": "Overlay color",
          "default": "#121212"
        },
        {
          "type": "range",
          "id": "overlay_opacity",
          "label": "Opacity",
          "min": 0,
          "max": 100,
          "step": 10,
          "default": 30,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "overlay_blur",
          "label": "Blur",
          "min": 0,
          "max": 10,
          "step": 1,
          "default": 0
        },
        {
          "type": "header",
          "content": "Caption"
        },
        {
          "type": "select",
          "id": "caption_position_mobile",
          "label": "Position - mobile",
          "default": "center",
          "options": [
            { "value": "top", "label": "Top" },
            { "value": "center", "label": "Center" },
            { "value": "bottom", "label": "Bottom" }
          ]
        },
        {
          "type": "select",
          "id": "caption_text_align_mobile",
          "label": "Text align - mobile",
          "default": "text-center",
          "options": [
            { "value": "text-start", "label": "Left" },
            { "value": "text-center", "label": "Center" },
            { "value": "text-end", "label": "Right" }
          ]
        },
        {
          "type": "select",
          "id": "caption_position_desktop",
          "label": "Position - desktop",
          "default": "center",
          "options": [
            { "value": "left", "label": "Left" },
            { "value": "center", "label": "Center" },
            { "value": "right", "label": "Right" },
            { "value": "bottom", "label": "Bottom" }
          ]
        },
        {
          "type": "select",
          "id": "caption_text_align_desktop",
          "label": "Text align - desktop",
          "default": "text-desktop-center",
          "options": [
            { "value": "text-desktop-start", "label": "Left" },
            { "value": "text-desktop-center", "label": "Center" },
            { "value": "text-desktop-end", "label": "Right" }
          ]
        },
        {
          "type": "text",
          "id": "caption_max_width",
          "label": "Caption max-width (px)",
          "default": "900"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle",
          "default": "Optional Subtitle",
          "info": "Leave empty to disable"
        },
        {
          "type": "select",
          "id": "subtitle_font_size",
          "label": "Subtitle font-size",
          "default": "fs-sm",
          "options": [
            { "value": "fs-xs", "label": "xs" },
            { "value": "fs-sm", "label": "sm" },
            { "value": "fs-md", "label": "md" },
            { "value": "fs-lg", "label": "lg" },
            { "value": "fs-xl", "label": "xl" }
          ]
        },
        {
          "type": "inline_richtext",
          "id": "title",
          "label": "Title",
          "default": "Welcome to our store",
          "info": "Leave empty to disable"
        },
        {
          "type": "select",
          "id": "title_font_size",
          "label": "Title font-size",
          "default": "h1",
          "options": [
            { "value": "h2", "label": "Small" },
            { "value": "h1", "label": "Medium" },
            { "value": "h0", "label": "Large" },
            { "value": "hxl", "label": "Extra large" },
            { "value": "hxxl", "label": "Extra extra large" }
          ]
        },
        {
          "type": "richtext",
          "id": "description",
          "label": "Description",
          "default": "<p>An optional description for this slide</p>",
          "info": "Leave empty to disable"
        },
        {
          "type": "select",
          "id": "description_font_size",
          "label": "Description font-size",
          "default": "fs-lg",
          "options": [
            { "value": "fs-xs", "label": "xs" },
            { "value": "fs-sm", "label": "sm" },
            { "value": "fs-md", "label": "md" },
            { "value": "fs-lg", "label": "lg" },
            { "value": "fs-xl", "label": "xl" }
          ]
        },
        {
          "type": "header",
          "content": "Primary button"
        },
        {
          "type": "text",
          "id": "btn_primary_text",
          "label": "Button text",
          "default": "Primary button",
          "info": "Leave empty to disable"
        },
        {
          "type": "select",
          "id": "btn_primary_style",
          "label": "Button style",
          "default": "button--primary",
          "options": [
            { "value": "button--primary", "label": "Primary" },
            { "value": "button--secondary", "label": "Secondary" }
          ]
        },
        {
          "type": "url",
          "id": "btn_primary_url",
          "label": "Button URL"
        },
        {
          "type": "header",
          "content": "Secondary button"
        },
        {
          "type": "text",
          "id": "btn_secondary_text",
          "label": "Button text",
          "default": "Secondary button",
          "info": "Leave empty to disable"
        },
        {
          "type": "select",
          "id": "btn_secondary_style",
          "label": "Button style",
          "default": "button--secondary",
          "options": [
            { "value": "button--primary", "label": "Primary" },
            { "value": "button--secondary", "label": "Secondary" }
          ]
        },
        {
          "type": "url",
          "id": "btn_secondary_url",
          "label": "Button URL"
        },
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "presets": [
    {
      "name": "KS - Fancy slideshow",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}