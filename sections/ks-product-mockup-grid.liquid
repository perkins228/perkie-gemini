{%- comment -%}
  Product Mockup Grid Section
  Displays customer's processed pet image on best-selling products
  Appears after pet processing completes on the pet-processor page
{%- endcomment -%}

{{ 'product-mockup-grid.css' | asset_url | stylesheet_tag }}

<section id="product-mockup-grid-{{ section.id }}"
         class="product-mockup-grid-section"
         data-section-id="{{ section.id }}"
         data-section-type="ks-product-mockup-grid"
         style="display: none;">

  <div class="page-width">
    {%- comment -%} Section Header {%- endcomment -%}
    <div class="mockup-grid__header">
      <h2 class="mockup-grid__heading">{{ section.settings.heading }}</h2>
      {% if section.settings.subheading != blank %}
        <p class="mockup-grid__subheading">{{ section.settings.subheading }}</p>
      {% endif %}
    </div>

    {%- comment -%} Loading State {%- endcomment -%}
    <div class="mockup-grid__loading" data-mockup-loading>
      <div class="mockup-grid__loading-spinner"></div>
      <p>Loading product previews...</p>
    </div>

    {%- comment -%} Product Grid Container - Populated by JavaScript {%- endcomment -%}
    <div class="mockup-grid__container" data-mockup-container>
      {%- comment -%}
        Initial products rendered server-side for SEO and fast initial paint
        Pet images will be overlaid via JavaScript
      {%- endcomment -%}
      <div class="mockup-grid__items" data-mockup-items>
        {%- for i in (1..10) -%}
          {%- assign product_setting = 'product_' | append: i -%}
          {%- assign product = section.settings[product_setting] -%}

          {%- if product != blank -%}
            {%- comment -%} Get positioning settings for this product {%- endcomment -%}
            {%- assign pos_top = 'product_' | append: i | append: '_top' -%}
            {%- assign pos_left = 'product_' | append: i | append: '_left' -%}
            {%- assign pos_width = 'product_' | append: i | append: '_width' -%}
            {%- assign pos_rotation = 'product_' | append: i | append: '_rotation' -%}
            {%- assign mockup_template_setting = 'product_' | append: i | append: '_mockup_template' -%}
            {%- assign mockup_template = section.settings[mockup_template_setting] -%}

            <div class="mockup-card {% if forloop.first %}mockup-card--hero{% endif %} {% if forloop.index > 3 %}mockup-card--expandable{% endif %}"
                 data-product-handle="{{ product.handle }}"
                 data-product-id="{{ product.id }}"
                 data-product-index="{{ forloop.index }}"
                 data-pet-top="{{ section.settings[pos_top] | default: 20 }}"
                 data-pet-left="{{ section.settings[pos_left] | default: 20 }}"
                 data-pet-width="{{ section.settings[pos_width] | default: 60 }}"
                 data-pet-rotation="{{ section.settings[pos_rotation] | default: 0 }}">

              <a href="{{ product.url }}" class="mockup-card__link" data-mockup-link>
                {%- comment -%} Image Container with Overlay {%- endcomment -%}
                <div class="mockup-card__image-container">
                  {%- comment -%} Product Template Image (Background) - Custom mockup or product image {%- endcomment -%}
                  {%- if mockup_template != blank -%}
                    <img src="{{ mockup_template | image_url: width: 800 }}"
                         srcset="{{ mockup_template | image_url: width: 400 }} 400w,
                                 {{ mockup_template | image_url: width: 800 }} 800w"
                         sizes="(max-width: 749px) 50vw, 220px"
                         alt="{{ product.title | escape }} mockup"
                         class="mockup-card__template"
                         loading="{% if forloop.index <= 3 %}eager{% else %}lazy{% endif %}"
                         width="800"
                         height="600">
                  {%- else -%}
                    <img src="{{ product.featured_image | image_url: width: 800 }}"
                         srcset="{{ product.featured_image | image_url: width: 400 }} 400w,
                                 {{ product.featured_image | image_url: width: 800 }} 800w"
                         sizes="(max-width: 749px) 50vw, 220px"
                         alt="{{ product.title | escape }}"
                         class="mockup-card__template"
                         loading="{% if forloop.index <= 3 %}eager{% else %}lazy{% endif %}"
                         width="800"
                         height="600">
                  {%- endif -%}

                  {%- comment -%} Pet Image Overlay - Positioned via CSS variables {%- endcomment -%}
                  <img src=""
                       alt="Your pet preview"
                       class="mockup-card__pet"
                       data-pet-overlay
                       style="--pet-top: {{ section.settings[pos_top] | default: 20 }}%;
                              --pet-left: {{ section.settings[pos_left] | default: 20 }}%;
                              --pet-width: {{ section.settings[pos_width] | default: 60 }}%;
                              --pet-rotation: {{ section.settings[pos_rotation] | default: 0 }}deg;">

                  {%- comment -%} Hero Badge for First Product {%- endcomment -%}
                  {% if forloop.first and section.settings.show_hero_badge %}
                    <span class="mockup-card__badge mockup-card__badge--popular">
                      {{ section.settings.hero_badge_text | default: 'Most Popular' }}
                    </span>
                  {% endif %}
                </div>

                {%- comment -%} Product Info {%- endcomment -%}
                <div class="mockup-card__info">
                  <h3 class="mockup-card__title">{{ product.title }}</h3>

                  <div class="mockup-card__meta">
                    <span class="mockup-card__price">
                      from {{ product.price_min | money }}
                    </span>
                    {% if product.variants.size > 1 %}
                      <span class="mockup-card__variants-count">
                        {{ product.variants.size }} sizes
                      </span>
                    {% endif %}
                  </div>

                  {%- comment -%} Star Rating if available {%- endcomment -%}
                  {% if product.metafields.reviews.rating.value != blank %}
                    <div class="mockup-card__rating">
                      {% render 'star-rating', rating: product.metafields.reviews.rating.value %}
                      {% if product.metafields.reviews.rating_count.value != blank %}
                        <span class="mockup-card__review-count">
                          ({{ product.metafields.reviews.rating_count.value }})
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>

                {%- comment -%} CTA Button {%- endcomment -%}
                <span class="mockup-card__cta">
                  See on {{ product.type | default: product.title | truncatewords: 2, '' }}
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                  </svg>
                </span>
              </a>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>

      {%- comment -%} Mobile Expand Toggle {%- endcomment -%}
      <button class="mockup-grid__toggle" data-mockup-toggle aria-expanded="false">
        <span class="mockup-grid__toggle-text" data-toggle-text>
          {{ section.settings.expand_button_text | default: 'See All 10 Products' }}
        </span>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mockup-grid__toggle-icon">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
    </div>
  </div>
</section>

{%- comment -%} Pass configuration to JavaScript {%- endcomment -%}
<script>
  window.productMockupGridConfig = window.productMockupGridConfig || {};
  window.productMockupGridConfig['{{ section.id }}'] = {
    sectionId: '{{ section.id }}',
    products: [
      {%- for i in (1..10) -%}
        {%- assign product_setting = 'product_' | append: i -%}
        {%- assign product = section.settings[product_setting] -%}
        {%- if product != blank -%}
          {%- assign pos_top = 'product_' | append: i | append: '_top' -%}
          {%- assign pos_left = 'product_' | append: i | append: '_left' -%}
          {%- assign pos_width = 'product_' | append: i | append: '_width' -%}
          {%- assign pos_rotation = 'product_' | append: i | append: '_rotation' -%}
          {
            id: {{ product.id | json }},
            handle: {{ product.handle | json }},
            title: {{ product.title | json }},
            type: {{ product.type | default: '' | json }},
            url: {{ product.url | json }},
            priceMin: {{ product.price_min }},
            priceMax: {{ product.price_max }},
            variantCount: {{ product.variants.size }},
            featuredImage: {{ product.featured_image | image_url: width: 800 | json }},
            position: {
              top: {{ section.settings[pos_top] | default: 20 }},
              left: {{ section.settings[pos_left] | default: 20 }},
              width: {{ section.settings[pos_width] | default: 60 }},
              rotation: {{ section.settings[pos_rotation] | default: 0 }}
            }
          }{% unless forloop.last %},{% endunless %}
        {%- endif -%}
      {%- endfor -%}
    ],
    settings: {
      heading: {{ section.settings.heading | json }},
      subheading: {{ section.settings.subheading | json }},
      showHeroBadge: {{ section.settings.show_hero_badge | json }},
      heroBadgeText: {{ section.settings.hero_badge_text | json }},
      expandButtonText: {{ section.settings.expand_button_text | json }},
      collapseButtonText: {{ section.settings.collapse_button_text | json }}
    }
  };
</script>

<script src="{{ 'product-mockup-renderer.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Product Mockup Grid",
  "tag": "section",
  "class": "section product-mockup-grid",
  "limit": 1,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "See Your Pet on Our Best-Sellers"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "Click any product to customize and order"
    },
    {
      "type": "header",
      "content": "Display Options"
    },
    {
      "type": "checkbox",
      "id": "show_hero_badge",
      "label": "Show badge on first product",
      "default": true
    },
    {
      "type": "text",
      "id": "hero_badge_text",
      "label": "Hero badge text",
      "default": "Most Popular"
    },
    {
      "type": "text",
      "id": "expand_button_text",
      "label": "Expand button text (mobile)",
      "default": "See All 10 Products"
    },
    {
      "type": "text",
      "id": "collapse_button_text",
      "label": "Collapse button text (mobile)",
      "default": "Show Less"
    },
    {
      "type": "header",
      "content": "Product 1 (Hero)"
    },
    {
      "type": "product",
      "id": "product_1",
      "label": "Product 1"
    },
    {
      "type": "image_picker",
      "id": "product_1_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_1_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_1_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_1_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_1_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 2"
    },
    {
      "type": "product",
      "id": "product_2",
      "label": "Product 2"
    },
    {
      "type": "image_picker",
      "id": "product_2_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_2_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_2_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_2_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_2_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 3"
    },
    {
      "type": "product",
      "id": "product_3",
      "label": "Product 3"
    },
    {
      "type": "image_picker",
      "id": "product_3_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_3_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_3_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_3_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_3_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 4"
    },
    {
      "type": "product",
      "id": "product_4",
      "label": "Product 4"
    },
    {
      "type": "image_picker",
      "id": "product_4_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_4_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_4_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_4_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_4_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 5"
    },
    {
      "type": "product",
      "id": "product_5",
      "label": "Product 5"
    },
    {
      "type": "image_picker",
      "id": "product_5_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_5_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_5_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_5_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_5_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 6"
    },
    {
      "type": "product",
      "id": "product_6",
      "label": "Product 6"
    },
    {
      "type": "image_picker",
      "id": "product_6_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_6_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_6_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_6_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_6_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 7"
    },
    {
      "type": "product",
      "id": "product_7",
      "label": "Product 7"
    },
    {
      "type": "image_picker",
      "id": "product_7_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_7_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_7_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_7_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_7_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 8"
    },
    {
      "type": "product",
      "id": "product_8",
      "label": "Product 8"
    },
    {
      "type": "image_picker",
      "id": "product_8_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_8_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_8_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_8_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_8_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 9"
    },
    {
      "type": "product",
      "id": "product_9",
      "label": "Product 9"
    },
    {
      "type": "image_picker",
      "id": "product_9_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_9_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_9_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_9_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_9_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    },
    {
      "type": "header",
      "content": "Product 10"
    },
    {
      "type": "product",
      "id": "product_10",
      "label": "Product 10"
    },
    {
      "type": "image_picker",
      "id": "product_10_mockup_template",
      "label": "Mockup Template Image",
      "info": "Upload a blank product mockup. Falls back to product image if not set."
    },
    {
      "type": "range",
      "id": "product_10_top",
      "label": "Pet position - Top %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_10_left",
      "label": "Pet position - Left %",
      "min": 0,
      "max": 80,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_10_width",
      "label": "Pet image width %",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "product_10_rotation",
      "label": "Pet image rotation",
      "min": -45,
      "max": 45,
      "step": 1,
      "default": 0,
      "unit": "deg"
    }
  ],
  "presets": [
    {
      "name": "Product Mockup Grid"
    }
  ]
}
{% endschema %}
