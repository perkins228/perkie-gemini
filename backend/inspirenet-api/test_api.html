<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perkie Print Headshot - Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7fafc;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header {
            background: #1a365d;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 { font-size: 24px; margin-bottom: 10px; }
        .status { font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #48bb78;
        }
        .status-dot.unavailable { background: #f56565; }
        .section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .hidden { display: none !important; }
        .upload-zone {
            border: 2px dashed #3182ce;
            background: #f7fafc;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-zone:hover { background: #ebf8ff; border-color: #2c5282; }
        .upload-zone.drag-over { background: #ebf8ff; border-style: solid; border-width: 3px; }
        .upload-icon { font-size: 48px; margin-bottom: 16px; }
        button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 16px;
        }
        button:hover { background: #2c5282; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        button.secondary {
            background: white;
            color: #718096;
            border: 1px solid #cbd5e0;
        }
        button.success { background: #48bb78; }
        button.success:hover { background: #38a169; }
        .preview-img, .result-img {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin: 16px 0;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .comparison { grid-template-columns: 1fr; }
        }
        .image-container {
            text-align: center;
        }
        .image-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }
        .checkerboard {
            background-image:
                linear-gradient(45deg, #e2e8f0 25%, transparent 25%),
                linear-gradient(-45deg, #e2e8f0 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #e2e8f0 75%),
                linear-gradient(-45deg, transparent 75%, #e2e8f0 75%);
            background-size: 32px 32px;
            background-position: 0 0, 0 16px, 16px -16px, -16px 0px;
            padding: 16px;
            border-radius: 4px;
        }
        .progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182ce, #2c5282);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .progress-text {
            margin-top: 8px;
            color: #718096;
            font-size: 14px;
            text-align: center;
        }
        .timer {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 16px 0;
            color: #2d3748;
        }
        .validation {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            padding: 16px;
            margin-top: 16px;
            border-radius: 4px;
        }
        .validation.fail {
            background: #fff5f5;
            border-left-color: #f56565;
        }
        .check-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .metadata {
            color: #718096;
            font-size: 14px;
            margin: 8px 0;
            text-align: center;
        }
        .error {
            background: #fff5f5;
            border: 1px solid #f56565;
            color: #c53030;
            padding: 16px;
            border-radius: 6px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêæ Perkie Print Headshot Tester</h1>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Checking API...</span>
            </div>
        </header>

        <!-- Upload Section -->
        <div class="section" id="uploadSection">
            <h2>Upload Pet Photo</h2>
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üì∏</div>
                <p><strong>Drag & drop pet photo here</strong></p>
                <p>or click to browse</p>
                <p class="metadata">Supports: JPG, PNG ‚Ä¢ Max: 50MB</p>
            </div>
            <input type="file" id="fileInput" accept="image/jpeg,image/png" hidden>
            <div id="uploadError" class="error hidden"></div>
        </div>

        <!-- Preview Section -->
        <div class="section hidden" id="previewSection">
            <h2>Preview</h2>
            <div style="text-align: center;">
                <img id="previewImg" class="preview-img" alt="Original image preview">
                <div class="metadata" id="imageMetadata"></div>
            </div>
            <button id="generateBtn">üé® Generate Headshot</button>
            <button class="secondary" id="changeBtn">Change Image</button>
        </div>

        <!-- Processing Section -->
        <div class="section hidden" id="processingSection">
            <h2>‚è≥ Processing...</h2>
            <div class="timer" id="timer">00:00</div>
            <div class="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="progress-text" id="progressText">Starting...</div>
            </div>
            <p class="metadata" style="text-align: center;">
                First request takes 30-60s (model loading)<br>
                Subsequent requests: 1-5s
            </p>
        </div>

        <!-- Results Section -->
        <div class="section hidden" id="resultsSection">
            <h2>‚ú® Results</h2>
            <div class="comparison">
                <div class="image-container">
                    <div class="image-label">Original</div>
                    <img id="originalImg" class="result-img" alt="Original image">
                </div>
                <div class="image-container">
                    <div class="image-label">Headshot (Transparent BG)</div>
                    <div class="checkerboard">
                        <img id="resultImg" class="result-img" alt="Headshot result">
                    </div>
                </div>
            </div>
            <button class="success" id="downloadBtn">‚¨áÔ∏è Download Headshot PNG</button>
            <button class="secondary" id="startOverBtn">Start Over</button>

            <!-- Validation -->
            <div id="validationSection" class="validation hidden">
                <h3 style="margin-bottom: 12px;">Quality Validation</h3>
                <div id="validationResults"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8888/api/v2/headshot';
        const HEALTH_URL = 'http://localhost:8888/health';

        let selectedFile = null;
        let originalBlob = null;
        let resultBlob = null;
        let startTime = null;
        let timerInterval = null;

        // DOM elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('resultsSection');
        const uploadError = document.getElementById('uploadError');
        const previewImg = document.getElementById('previewImg');
        const imageMetadata = document.getElementById('imageMetadata');
        const generateBtn = document.getElementById('generateBtn');
        const changeBtn = document.getElementById('changeBtn');
        const timer = document.getElementById('timer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const originalImg = document.getElementById('originalImg');
        const resultImg = document.getElementById('resultImg');
        const downloadBtn = document.getElementById('downloadBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        const validationSection = document.getElementById('validationSection');
        const validationResults = document.getElementById('validationResults');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Check API health
        async function checkAPI() {
            try {
                const response = await fetch(HEALTH_URL, { signal: AbortSignal.timeout(5000) });
                if (response.ok) {
                    statusDot.classList.remove('unavailable');
                    statusText.textContent = 'API Ready ‚úÖ';
                    return true;
                }
            } catch (e) {
                statusDot.classList.add('unavailable');
                statusText.textContent = 'API Unavailable ‚ùå (Start server on port 8888)';
                return false;
            }
        }

        // Upload handlers
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            uploadError.classList.add('hidden');

            // Validate file
            if (!file.type.match('image/(jpeg|png)')) {
                showError('Please select a JPEG or PNG image');
                return;
            }
            if (file.size > 50 * 1024 * 1024) {
                showError(`File too large: ${(file.size/1024/1024).toFixed(1)}MB (max 50MB)`);
                return;
            }

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                originalBlob = file;

                // Get dimensions
                const img = new Image();
                img.onload = () => {
                    imageMetadata.textContent = `${img.width}√ó${img.height} ‚Ä¢ ${(file.size/1024/1024).toFixed(1)} MB ‚Ä¢ ${file.type.split('/')[1].toUpperCase()}`;
                };
                img.src = e.target.result;

                uploadSection.classList.add('hidden');
                previewSection.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function showError(msg) {
            uploadError.textContent = msg;
            uploadError.classList.remove('hidden');
        }

        // Generate button
        generateBtn.addEventListener('click', async () => {
            previewSection.classList.add('hidden');
            processingSection.classList.remove('hidden');

            startTime = Date.now();
            startTimer();

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                // Simulate progress
                simulateProgress();

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                    signal: AbortSignal.timeout(120000)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }

                // Extract confidence headers from enhanced cropping
                const cropConfidence = response.headers.get('X-Crop-Confidence');
                const cropConfidenceLevel = response.headers.get('X-Crop-Confidence-Level');
                const processingTime = response.headers.get('X-Processing-Time');

                resultBlob = await response.blob();
                stopTimer();
                updateProgress(100, 'Complete!');

                // Store confidence for display
                window.cropConfidence = cropConfidence;
                window.cropConfidenceLevel = cropConfidenceLevel;
                window.processingTime = processingTime;

                setTimeout(() => showResults(), 500);

            } catch (error) {
                stopTimer();
                alert(`Processing failed: ${error.message}`);
                processingSection.classList.add('hidden');
                previewSection.classList.remove('hidden');
            }
        });

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                timer.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
        }

        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;

                if (elapsed < 30) {
                    progress = (elapsed / 30) * 60;
                    updateProgress(progress, 'Removing background...');
                } else if (elapsed < 45) {
                    progress = 60 + ((elapsed - 30) / 15) * 30;
                    updateProgress(progress, 'Converting to B&W...');
                } else {
                    progress = 90 + ((elapsed - 45) / 10) * 8;
                    updateProgress(Math.min(progress, 98), 'Cropping headshot...');
                }
            }, 500);

            // Store interval to clear it later
            window.progressInterval = interval;
        }

        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressFill.textContent = `${Math.round(percent)}%`;
            progressText.textContent = text;
        }

        function showResults() {
            if (window.progressInterval) clearInterval(window.progressInterval);

            processingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            // Show images
            originalImg.src = URL.createObjectURL(originalBlob);
            resultImg.src = URL.createObjectURL(resultBlob);

            // Run validation
            validateResult();
        }

        async function validateResult() {
            const img = new Image();
            img.onload = () => {
                const ratio = img.width / img.height;
                const expectedRatio = 0.8; // 4:5
                const ratioPass = Math.abs(ratio - expectedRatio) < 0.05;

                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;

                // Check transparency
                let transparentCount = 0;
                for (let i = 3; i < pixels.length; i += 40) {
                    if (pixels[i] < 255) transparentCount++;
                }
                const transparentPercent = (transparentCount / (pixels.length / 40)) * 100;
                const transparentPass = transparentPercent > 5;

                // Check grayscale
                let grayscaleCount = 0;
                for (let i = 0; i < 100; i++) {
                    const idx = Math.floor(Math.random() * (pixels.length / 4)) * 4;
                    const r = pixels[idx], g = pixels[idx + 1], b = pixels[idx + 2];
                    if (Math.abs(r - g) < 5 && Math.abs(g - b) < 5) grayscaleCount++;
                }
                const grayscalePass = grayscaleCount > 95;

                validationSection.classList.remove('hidden');
                if (!ratioPass || !transparentPass || !grayscalePass) {
                    validationSection.classList.add('fail');
                }

                // Enhanced cropping confidence score
                const confidence = window.cropConfidence;
                const confidenceLevel = window.cropConfidenceLevel;
                const processingTime = window.processingTime;

                let confidenceIcon = '‚ùì';
                let confidenceColor = '#718096';
                if (confidenceLevel === 'high') {
                    confidenceIcon = '‚úÖ';
                    confidenceColor = '#48bb78';
                } else if (confidenceLevel === 'medium') {
                    confidenceIcon = '‚ö†Ô∏è';
                    confidenceColor = '#ed8936';
                } else if (confidenceLevel === 'low') {
                    confidenceIcon = '‚ùå';
                    confidenceColor = '#f56565';
                }

                validationResults.innerHTML = `
                    <div class="check-item">${ratioPass ? '‚úÖ' : '‚ùå'} Aspect Ratio: ${ratio.toFixed(3)} (expected 0.800 for 4:5)</div>
                    <div class="check-item">${transparentPass ? '‚úÖ' : '‚ùå'} Transparency: ${transparentPercent.toFixed(1)}% (min 5%)</div>
                    <div class="check-item">${grayscalePass ? '‚úÖ' : '‚ùå'} Grayscale: ${grayscaleCount}% of samples</div>
                    ${confidence ? `<div class="check-item" style="color: ${confidenceColor}; font-weight: 600;">${confidenceIcon} <strong>Crop Confidence:</strong> ${(parseFloat(confidence) * 100).toFixed(0)}% (${confidenceLevel})</div>` : ''}
                    <div class="check-item">‚ÑπÔ∏è Dimensions: ${img.width}√ó${img.height}</div>
                    <div class="check-item">‚ÑπÔ∏è File Size: ${(resultBlob.size/1024/1024).toFixed(1)} MB</div>
                    ${processingTime ? `<div class="check-item">‚è±Ô∏è Processing Time: ${processingTime}s</div>` : ''}
                `;
            };
            img.src = URL.createObjectURL(resultBlob);
        }

        // Download
        downloadBtn.addEventListener('click', () => {
            const url = URL.createObjectURL(resultBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `perkie-headshot-${Date.now()}.png`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Start over
        changeBtn.addEventListener('click', startOver);
        startOverBtn.addEventListener('click', startOver);

        function startOver() {
            previewSection.classList.add('hidden');
            processingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            validationSection.classList.add('hidden');
            validationSection.classList.remove('fail');
            fileInput.value = '';
            selectedFile = null;
        }

        // Initialize
        checkAPI();
        setInterval(checkAPI, 30000); // Check every 30s
    </script>
</body>
</html>
