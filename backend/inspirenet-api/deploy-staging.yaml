apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: inspirenet-bg-removal-api-staging
  annotations:
    run.googleapis.com/ingress: all
    run.googleapis.com/description: "Staging InSPyReNet API - Validation Environment"
spec:
  template:
    metadata:
      annotations:
        # Execution environment
        run.googleapis.com/execution-environment: gen2
        
        # Staging scaling configuration - Cost optimized for testing
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "2"
        autoscaling.knative.dev/maxConcurrency: "1"
        
        # Performance optimizations
        run.googleapis.com/startup-cpu-boost: "true"
        run.googleapis.com/cpu-throttling: "false"
        
        # Health check configuration
        run.googleapis.com/health-check-path: "/health"
        run.googleapis.com/health-check-interval: "30s"
        run.googleapis.com/health-check-timeout: "10s"
        run.googleapis.com/health-check-failure-threshold: "3"
        
        # Startup probe configuration
        run.googleapis.com/startup-probe-path: "/health"
        run.googleapis.com/startup-probe-initial-delay: "60s"
        run.googleapis.com/startup-probe-timeout: "30s"
        run.googleapis.com/startup-probe-period: "30s"
        run.googleapis.com/startup-probe-failure-threshold: "10"
        
        # Timeout configuration
        run.googleapis.com/timeout: "600s"
        
        # Memory configuration - Reduced for staging cost optimization
        run.googleapis.com/memory: "16Gi"
        
        # GPU configuration
        run.googleapis.com/gpu-zonal-redundancy-disabled: "true"
        
    spec:
      containers:
      - image: us-central1-docker.pkg.dev/perkieprints-processing/pet-bg-removal/inspirenet-bg-removal-api:staging
        ports:
        - containerPort: 8080
          name: http1
        resources:
          limits:
            cpu: '4'
            memory: '16Gi'
            nvidia.com/gpu: '1'
          requests:
            cpu: '2'
            memory: '16Gi'
            nvidia.com/gpu: '1'
        env:
        # Environment identification
        - name: DEPLOYMENT_ENV
          value: "staging"
        
        # Model configuration
        - name: MODEL_PATH
          value: "/app/models/inspirenet.pth"
        - name: TARGET_SIZE
          value: "1024"
        - name: INSPIRENET_MODE
          value: "base"
        - name: INSPIRENET_RESIZE
          value: "dynamic"
        - name: MODEL_LOAD_TIMEOUT
          value: "120"
        
        # Storage configuration - Staging buckets
        - name: STORAGE_BUCKET
          value: "perkieprints-staging-cache"
        - name: CUSTOMER_STORAGE_BUCKET
          value: "perkieprints-staging-customer-images"
        - name: CACHE_TTL
          value: "3600"  # Shorter cache for testing
        
        # Performance configuration
        - name: MIN_INSTANCES
          value: "0"
        - name: MAX_CONCURRENT_REQUESTS
          value: "1"
        - name: MAX_PARALLEL_EFFECTS
          value: "2"  # Reduced for staging
        
        # Feature toggles
        - name: ENABLE_OPTIMIZATIONS
          value: "true"
        - name: ENABLE_WARMUP
          value: "true"
        - name: ENABLE_MEMORY_MONITORING
          value: "true"
        - name: ENABLE_GPU_OPTIMIZATIONS
          value: "true"
        - name: ENABLE_RATE_LIMITING
          value: "true"  # Test rate limiting in staging
        
        # Memory thresholds
        - name: MEMORY_THRESHOLD_CPU
          value: "0.80"  # More aggressive for smaller memory
        - name: MEMORY_THRESHOLD_GPU
          value: "0.85"
        - name: MEMORY_CLEANUP_INTERVAL
          value: "20"
        
        # System configuration
        - name: GOOGLE_CLOUD_PROJECT
          value: "perkieprints-processing"
        - name: LOG_LEVEL
          value: "debug"  # More verbose logging for staging
        
        # Resource limits
        - name: MAX_IMAGE_SIZE_MB
          value: "30"
        - name: MOBILE_MAX_SIZE
          value: "1280"
        - name: EFFECTS_BATCH_SIZE
          value: "2"
        
        # Rate limiting configuration (staging testing)
        - name: RATE_LIMIT_PER_IP
          value: "50"  # Lower limits for testing
        - name: RATE_LIMIT_PER_SESSION
          value: "10"
        - name: RATE_LIMIT_WINDOW_SECONDS
          value: "60"
        
        # PyTorch and CUDA configuration
        - name: OMP_NUM_THREADS
          value: "2"  # Reduced for staging
        - name: MKL_NUM_THREADS
          value: "2"
        - name: NUMEXPR_NUM_THREADS
          value: "2"
        - name: CUDA_VISIBLE_DEVICES
          value: "0"
        - name: NVIDIA_VISIBLE_DEVICES
          value: "0"
        - name: PYTORCH_CUDA_ALLOC_CONF
          value: "max_split_size_mb:64,expandable_segments:True"