<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebP Thumbnail Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .thumbnail-container {
            text-align: center;
        }
        
        .thumbnail-container picture {
            display: block;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iI2NjYyIvPgogIDxyZWN0IHg9IjUiIHk9IjUiIHdpZHRoPSI1IiBoZWlnaHQ9IjUiIGZpbGw9IiNjY2MiLz4KPC9zdmc+');
            background-size: 20px 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .thumbnail-container img {
            max-width: 150px;
            max-height: 150px;
            display: block;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .format-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .file-size-comparison {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .size-info {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .savings {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>WebP Thumbnail Generation Test</h1>
    
    <div class="test-section">
        <h2>WebP Support Detection</h2>
        <div id="webp-support"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Image Upload</h2>
        <input type="file" id="file-input" accept="image/*">
        <button onclick="testThumbnailGeneration()">Generate Thumbnails</button>
        <div id="status" class="status" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>Generated Thumbnails</h2>
        <div id="thumbnail-grid" class="test-grid"></div>
        <div id="size-comparison" class="file-size-comparison" style="display: none;"></div>
    </div>

    <script>
        // Test WebP support
        async function checkWebPSupport() {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = canvas.height = 1;
                const blob = await new Promise((resolve) => {
                    canvas.toBlob(resolve, 'image/webp', 0.9);
                });
                return blob !== null && blob.type === 'image/webp';
            } catch (e) {
                return false;
            }
        }
        
        // Generate thumbnail function (same as in main code)
        async function generateThumbnail(blob, size = 150) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = async () => {
                    // Calculate aspect ratio
                    const aspectRatio = img.width / img.height;
                    let width = size;
                    let height = size;
                    
                    if (aspectRatio > 1) {
                        height = size / aspectRatio;
                    } else {
                        width = size * aspectRatio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Clear canvas with transparent background
                    ctx.clearRect(0, 0, width, height);
                    
                    // Draw scaled image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Generate both WebP and PNG versions
                    try {
                        const thumbnails = {};
                        
                        // Check WebP support
                        const supportsWebP = await checkWebPSupport();
                        
                        if (supportsWebP) {
                            // Generate WebP with transparency
                            await new Promise((resolveWebP) => {
                                canvas.toBlob((webpBlob) => {
                                    thumbnails.webp = webpBlob;
                                    resolveWebP();
                                }, 'image/webp', 0.9); // High quality for transparency
                            });
                        }
                        
                        // Always generate PNG as fallback
                        await new Promise((resolvePNG) => {
                            canvas.toBlob((pngBlob) => {
                                thumbnails.png = pngBlob;
                                resolvePNG();
                            }, 'image/png');
                        });
                        
                        resolve(thumbnails);
                        
                        // Clean up
                        URL.revokeObjectURL(img.src);
                    } catch (error) {
                        // Fallback to PNG only if WebP generation fails
                        canvas.toBlob((thumbnailBlob) => {
                            resolve({ png: thumbnailBlob });
                            URL.revokeObjectURL(img.src);
                        }, 'image/png');
                    }
                };
                
                img.onerror = () => {
                    reject(new Error('Failed to load image for thumbnail'));
                    URL.revokeObjectURL(img.src);
                };
                
                img.src = URL.createObjectURL(blob);
            });
        }
        
        // Display WebP support status
        checkWebPSupport().then(supported => {
            const supportDiv = document.getElementById('webp-support');
            supportDiv.innerHTML = `
                <p>WebP Support: <strong>${supported ? 'YES' : 'NO'}</strong></p>
                <p>Browser: ${navigator.userAgent}</p>
            `;
            supportDiv.className = supported ? 'status success' : 'status error';
        });
        
        // Test thumbnail generation
        async function testThumbnailGeneration() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select an image file', 'error');
                return;
            }
            
            showStatus('Generating thumbnails...', 'success');
            
            try {
                const thumbnails = await generateThumbnail(file);
                displayThumbnails(thumbnails);
                showSizeComparison(thumbnails);
                showStatus('Thumbnails generated successfully!', 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        function displayThumbnails(thumbnails) {
            const grid = document.getElementById('thumbnail-grid');
            grid.innerHTML = '';
            
            // Display WebP version
            if (thumbnails.webp) {
                const webpContainer = createThumbnailDisplay(thumbnails.webp, 'WebP Format', 'webp');
                grid.appendChild(webpContainer);
            }
            
            // Display PNG version
            if (thumbnails.png) {
                const pngContainer = createThumbnailDisplay(thumbnails.png, 'PNG Format', 'png');
                grid.appendChild(pngContainer);
            }
            
            // Display with picture element
            if (thumbnails.webp && thumbnails.png) {
                const pictureContainer = createPictureElement(thumbnails);
                grid.appendChild(pictureContainer);
            }
        }
        
        function createThumbnailDisplay(blob, label, format) {
            const container = document.createElement('div');
            container.className = 'thumbnail-container';
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            
            const info = document.createElement('div');
            info.className = 'format-info';
            info.innerHTML = `
                <strong>${label}</strong><br>
                Size: ${formatBytes(blob.size)}<br>
                Type: ${blob.type}
            `;
            
            container.appendChild(img);
            container.appendChild(info);
            
            return container;
        }
        
        function createPictureElement(thumbnails) {
            const container = document.createElement('div');
            container.className = 'thumbnail-container';
            
            const picture = document.createElement('picture');
            
            // Add WebP source
            if (thumbnails.webp) {
                const source = document.createElement('source');
                source.srcset = URL.createObjectURL(thumbnails.webp);
                source.type = 'image/webp';
                picture.appendChild(source);
            }
            
            // Add PNG fallback
            const img = document.createElement('img');
            img.src = URL.createObjectURL(thumbnails.png);
            img.alt = 'Thumbnail with WebP/PNG fallback';
            picture.appendChild(img);
            
            const info = document.createElement('div');
            info.className = 'format-info';
            info.innerHTML = '<strong>Picture Element</strong><br>(WebP with PNG fallback)';
            
            container.appendChild(picture);
            container.appendChild(info);
            
            return container;
        }
        
        function showSizeComparison(thumbnails) {
            const comparison = document.getElementById('size-comparison');
            comparison.style.display = 'block';
            
            let html = '<h3>File Size Comparison</h3>';
            
            if (thumbnails.webp && thumbnails.png) {
                const webpSize = thumbnails.webp.size;
                const pngSize = thumbnails.png.size;
                const savings = ((pngSize - webpSize) / pngSize * 100).toFixed(1);
                
                html += `
                    <div class="size-info">
                        <span>PNG Size:</span>
                        <span>${formatBytes(pngSize)}</span>
                    </div>
                    <div class="size-info">
                        <span>WebP Size:</span>
                        <span>${formatBytes(webpSize)}</span>
                    </div>
                    <div class="size-info savings">
                        <span>Size Reduction:</span>
                        <span>${savings}% smaller</span>
                    </div>
                `;
            }
            
            comparison.innerHTML = html;
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
    </script>
</body>
</html>