# Perkie Prints Customer Funnel Verification Plan

## System Overview
The Perkie Prints system consists of:
- **Pet Processor** (`assets/pet-processor.js`): 600 lines, ES6+ mobile-first implementation
- **Pet Storage** (`assets/pet-storage.js`): 91 lines, single sessionStorage mechanism
- **Pet Selector** (`snippets/ks-product-pet-selector.liquid`): Inline JS with localStorage fallback
- **API Service**: InSPyReNet background removal with 4 effects

## Verification Checklist

### 1. ‚úÖ **Image Upload and Processing Pipeline**

#### Root Cause Analysis
- **VERIFIED**: API response handling fixed with `return_all_effects=true` parameter
- **VERIFIED**: Response parsing properly handles base64-encoded effects
- **WORKING**: File upload, EXIF rotation, and API communication

#### Architecture Assessment
- **GOOD**: Clean separation between processor and storage
- **ISSUE**: Inconsistent storage between processor (sessionStorage) and selector (localStorage)
- **RECOMMENDATION**: Unify storage mechanism across components

#### Solution Quality
- **SIMPLICITY**: ‚úÖ 600 lines vs 2,343 lines (74% reduction)
- **COMPLETENESS**: ‚úÖ All 4 effects generated and accessible
- **MAINTAINABILITY**: ‚úÖ ES6+ modern JavaScript

#### Security Audit
- **FILE VALIDATION**: ‚úÖ Type and size checks (10MB limit)
- **API SECURITY**: ‚ö†Ô∏è No authentication on API endpoints
- **DATA PROTECTION**: ‚úÖ No sensitive data in storage

#### Integration Testing
- **API CONNECTIVITY**: ‚úÖ Proper error handling and retry logic
- **PROGRESS FEEDBACK**: ‚úÖ Real-time progress updates
- **ERROR RECOVERY**: ‚úÖ Try again functionality

### 2. ‚úÖ **Effect Selection System**

#### Current Implementation
- **Effects Available**: enhancedblackwhite, popart, dithering, color
- **Default Effect**: enhancedblackwhite
- **Switching**: Real-time effect switching without re-processing

#### Verification Points
- ‚úÖ All effects properly generated by API
- ‚úÖ Effect buttons correctly update active state
- ‚úÖ Image src updates when switching effects
- ‚úÖ Selected effect persisted in `currentPet.selectedEffect`

### 3. ‚ö†Ô∏è **Pet Name and Artist Notes Functionality**

#### Current State
- **Pet Name**: ‚úÖ Input field present and functional
- **Artist Notes**: ‚ùå NOT IMPLEMENTED in simplified version

#### Critical Issues
- **MISSING**: Artist notes field completely removed from UI
- **MISSING**: Artist notes not saved to storage
- **MISSING**: Artist notes not passed to cart properties

#### Impact
- **SEVERITY**: Medium - Feature mentioned in requirements but not critical for MVP
- **RECOMMENDATION**: Add artist notes field if required for fulfillment

### 4. ‚ö†Ô∏è **Order Metadata Integration**

#### Current Implementation
```javascript
// Pet Storage saves:
{
  petId: 'pet_1234',
  name: 'Fluffy',
  effect: 'popart',
  thumbnail: 'data:image/png;base64...',
  gcsUrl: '' // NOT SET - Critical issue
}
```

#### Critical Issues
- **GCS URL**: ‚ùå Not uploaded to Google Cloud Storage
- **Cart Properties**: ‚ö†Ô∏è References missing in buy-buttons.liquid
- **Metadata Fields**: Partial implementation

#### Required Cart Properties
```liquid
properties[_original_image_url]: GCS URL needed
properties[_processed_image_url]: GCS URL needed
properties[_pet_name]: ‚úÖ Available
properties[_effect_applied]: ‚úÖ Available
properties[_artist_notes]: ‚ùå Not collected
```

### 5. ‚ùå **Thumbnail Generation and Display**

#### Critical Failure Points
- **Storage Mismatch**: Processor uses sessionStorage, Selector reads localStorage
- **Data Loss**: Thumbnails not persisting across page navigation
- **Blob URL Issues**: Blob URLs invalid after page reload

#### Root Cause
1. `pet-processor.js` saves to sessionStorage via `PetStorage.save()`
2. `ks-product-pet-selector.liquid` reads from localStorage/window.perkieEffects
3. No synchronization mechanism between storage systems

#### Immediate Fix Required
```javascript
// After successful processing in pet-processor.js
localStorage.setItem('perkieEffects_selected', JSON.stringify({
  [`${petId}_${effect}`]: dataUrl,
  [`${petId}_metadata`]: { name, timestamp }
}));
```

### 6. ‚ö†Ô∏è **Multi-Pet Workflow**

#### Current State
- **UI**: "Add to Cart" button, no explicit "Add Another Pet"
- **Storage**: Supports multiple pets in theory
- **Selector**: Can display multiple pet thumbnails

#### Issues
- **UX Confusion**: Not clear how to add multiple pets
- **State Management**: Current pet resets after save
- **Max Pets**: Configuration exists but not enforced

### 7. ‚ùå **Pet Selection in Selector**

#### Critical Issues
- **No Thumbnails**: Selector shows empty state even after processing
- **Selection Logic**: Click handlers not properly implemented
- **Selected State**: No visual feedback for selected pets

#### Required Functionality
1. Display saved pet thumbnails in grid
2. Click to select/deselect pets
3. Show checkmark on selected pets
4. Update cart properties with selected pets

### 8. ‚ö†Ô∏è **Pet Removal from Selector**

#### Current Implementation
- **Edit Mode**: Button exists but functionality unclear
- **Deletion**: No clear deletion mechanism
- **Storage Cleanup**: `PetStorage.delete()` exists but not wired to UI

### 9. ‚ùå **Cart Integration**

#### Critical Failures
1. **No GCS Upload**: Images remain as data URLs, not uploaded to cloud
2. **Missing Properties**: Cart properties not populated
3. **Global State**: `window.perkiePets` not properly synced

#### Required Flow
1. Process image ‚Üí Generate effects
2. Upload to GCS ‚Üí Get permanent URLs
3. Save URLs to storage
4. Populate cart properties on add to cart
5. Include pet data in order line items

## Critical Failure Points to Test

### Test Scenario 1: Complete Flow
1. **Upload Image** ‚Üí Should show processing
2. **Select Effect** ‚Üí Should switch instantly
3. **Enter Pet Name** ‚Üí Should save with pet
4. **Add to Cart** ‚Üí Should save to storage
5. **Navigate to Product** ‚Üí Should show thumbnail
6. **Select Pet** ‚Üí Should show selected state
7. **Add Product to Cart** ‚Üí Should include pet metadata

**Current Result**: FAILS at step 5 - No thumbnails appear

### Test Scenario 2: Multi-Pet Flow
1. Process first pet
2. Click "Add to Cart" on processor
3. Process second pet
4. Navigate to product page
5. Should see both pets in selector

**Current Result**: FAILS - Only shows empty state

### Test Scenario 3: Cart Metadata
1. Process pet with name "Fluffy"
2. Select "Pop Art" effect
3. Add to product
4. Check cart API response

**Expected**: Pet data in line item properties
**Current Result**: FAILS - No pet properties included

## Integration Points Needing Attention

### 1. Storage Synchronization
**Problem**: sessionStorage vs localStorage mismatch
**Solution**: Implement unified storage with cross-tab sync
```javascript
// Save to both storages
sessionStorage.setItem(key, data);
localStorage.setItem(key + '_backup', data);
window.dispatchEvent(new Event('storage'));
```

### 2. GCS Upload Implementation
**Problem**: No cloud upload, using data URLs
**Solution**: Implement upload endpoint
```javascript
async function uploadToGCS(dataUrl, filename) {
  const response = await fetch('/api/upload', {
    method: 'POST',
    body: JSON.stringify({ image: dataUrl, filename })
  });
  return response.json(); // { gcsUrl: '...' }
}
```

### 3. Cart Property Population
**Problem**: Hidden inputs not populated
**Solution**: Update on pet selection
```javascript
function updateCartProperties(petData) {
  document.getElementById('original-url-').value = petData.gcsUrl;
  document.getElementById('pet-name-').value = petData.name;
  document.getElementById('effect-applied-').value = petData.effect;
  document.getElementById('has-custom-pet-').value = 'true';
}
```

## Recommendations

### Priority 1: Critical Fixes (Must Have)
1. **Fix Storage Synchronization**: Unify storage mechanism
2. **Implement GCS Upload**: Required for fulfillment
3. **Fix Thumbnail Display**: Pets must appear in selector
4. **Wire Cart Properties**: Order metadata required

### Priority 2: Important Features (Should Have)
1. **Add Artist Notes**: If required for fulfillment
2. **Improve Multi-Pet UX**: Clear "Add Another" flow
3. **Implement Pet Deletion**: Edit mode functionality
4. **Add Selection Feedback**: Visual checkmarks

### Priority 3: Nice to Have
1. **Cross-tab Synchronization**: Real-time updates
2. **Persistence Across Sessions**: 24-48 hour retention
3. **Loading States**: Better feedback during operations
4. **Error Recovery**: More robust error handling

## Missing Functionality Summary

### ‚ùå **Critical (Blocks Launch)**
- GCS upload for permanent URLs
- Storage synchronization 
- Thumbnail display in selector
- Cart property integration

### ‚ö†Ô∏è **Important (Affects UX)**
- Artist notes collection
- Multi-pet workflow clarity
- Pet deletion capability
- Selection state management

### üí° **Enhancements**
- Cross-tab sync
- Better error messages
- Loading animations
- Progress indicators

## Overall Verdict: **CONDITIONAL APPROVAL**

### Approved Components
- ‚úÖ Image upload and processing
- ‚úÖ Effect generation and switching
- ‚úÖ Pet name collection
- ‚úÖ Basic storage implementation

### Requires Immediate Fix
- ‚ùå Storage synchronization between processor and selector
- ‚ùå GCS upload implementation
- ‚ùå Cart metadata integration
- ‚ùå Thumbnail display functionality

### Risk Assessment
**Deployment Risk**: HIGH
- System is not functional end-to-end
- Customer cannot complete purchase flow with custom pet
- Fulfillment team cannot access pet images

**Recommended Action**: Fix critical issues before any production deployment

## Testing Commands

```javascript
// Debug storage state
console.log('SessionStorage:', sessionStorage);
console.log('LocalStorage pets:', localStorage.getItem('perkieEffects_selected'));
console.log('Global pets:', window.perkiePets);

// Test storage sync
PetStorage.save('test_pet', {
  name: 'Test',
  thumbnail: 'data:image/png;base64,test',
  effect: 'popart'
});

// Check if selector can see it
window.perkieEffects = new Map();
loadSavedPets(); // Should show thumbnail
```