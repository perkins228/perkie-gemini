# Product Page Pet Selector URL Construction Error - Debug Analysis

**Created**: 2025-08-16  
**Status**: Root Cause Analysis Completed  
**Severity**: Critical - Blocking product page functionality  

## Error Summary

```
Uncaught (in promise) TypeError: Failed to construct 'URL': Invalid URL
    at W (s87104074w193399d0p9c2c7174m0f111275m.js:1:61974)
    at r.XMLHttpRequest.XMLHttpRequest.open (s87104074w193399d0p9c2c7174m0f111275m.js:1:71370)
```

**Context**: Error occurs specifically on product detail pages with pet selector, not on the dedicated pet processing page.

## Root Cause Analysis

### Primary Root Cause: Blob URL + Shopify Analytics Conflict

The error occurs when **Shopify's analytics/tracking systems attempt to track or process blob: URLs** generated by the pet processor system.

**Technical Breakdown**:
1. Pet processor creates blob URLs for processed images: `blob:https://domain.com/uuid`
2. These blob URLs are stored in `window.perkieEffects` Map
3. Pet selector renders `<img>` elements with blob URLs as `src` attributes
4. **Shopify's web pixels/analytics** attempt to track image loading events
5. Analytics code tries to construct new `URL()` objects from blob URLs
6. **URL constructor fails** when given blob URLs in certain contexts

### Secondary Contributing Factors

1. **Environment Difference**: 
   - Processing page: Standalone, minimal analytics tracking
   - Product page: Full e-commerce tracking (checkout, analytics, pixels)

2. **XMLHttpRequest Context**:
   - Analytics trying to preload/validate image URLs
   - Blob URLs cannot be fetched via standard HTTP requests
   - URL constructor fails when analytics assumes standard HTTP URLs

3. **Timing Issues**:
   - Event dispatched: `petProcessorComplete` (fixed from `petProcessorPrimaryComplete`)
   - Pet selector refreshes and renders new blob URLs
   - Shopify analytics immediately attempts to track the new images

## Architecture Analysis

### Working Flow (Processing Page)
```
1. User uploads image → Pet Processor
2. API returns base64 → Converted to blob URLs
3. Blob URLs stored in window.perkieEffects
4. Images displayed directly ✅
```

### Broken Flow (Product Page)
```
1. User uploads image → Pet Processor
2. API returns base64 → Converted to blob URLs
3. Blob URLs stored in window.perkieEffects
4. Pet selector receives 'petProcessorComplete' event
5. Pet selector renders images with blob URLs
6. Shopify analytics/pixels try to track blob URLs ❌
7. URL() constructor fails on blob URLs
```

## Evidence Supporting Analysis

### 1. Error Stack Trace Points to Shopify Core
- `s87104074w193399d0p9c2c7174m0f111275m.js` - Shopify's minified core
- `web-pixel-1022754899` - Shopify analytics/tracking pixel
- `XMLHttpRequest.open` - Analytics attempting HTTP request

### 2. Product Page vs Processing Page Behavior
- **Processing page**: Works perfectly (minimal analytics)
- **Product page**: Fails (full e-commerce analytics stack)

### 3. Blob URL Pattern
```javascript
// Pet processor creates these URLs:
blob:https://perkieprints.myshopify.com/550e8400-e29b-41d4-a716-446655440000

// Shopify analytics expects these URLs:
https://cdn.shopify.com/s/files/1/0123/4567/products/image.jpg
```

## Solution Strategy

### Option 1: Data URL Conversion (Recommended)
**Convert blob URLs to data URLs before rendering in pet selector**

**Implementation**:
```javascript
// In pet selector rendering logic
function convertBlobToDataUrl(blobUrl) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', blobUrl);
    xhr.responseType = 'blob';
    xhr.onload = function() {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(xhr.response);
    };
    xhr.onerror = reject;
    xhr.send();
  });
}
```

**Pros**:
- Data URLs don't trigger analytics tracking
- No URL validation issues
- Maintains image quality
- Compatible with all browsers

**Cons**:
- Slightly larger memory footprint
- Requires async conversion

### Option 2: Analytics Exclusion
**Exclude pet selector images from analytics tracking**

**Implementation**:
```javascript
// Add data attribute to exclude from tracking
<img src="${blobUrl}" 
     data-no-track="true" 
     data-analytics-skip="true"
     class="ks-pet-selector__pet-image">
```

**Pros**:
- Maintains blob URLs (better memory)
- Minimal code changes

**Cons**:
- Relies on Shopify analytics respecting exclusion flags
- May not work with all tracking systems

### Option 3: Hybrid Storage
**Use data URLs for product page, blob URLs for processing page**

**Implementation**:
```javascript
// Detect context and choose storage format
const isProductPage = window.location.pathname.includes('/products/');
const storageFormat = isProductPage ? 'data' : 'blob';
```

## Implementation Plan

### Phase 1: Immediate Fix (Data URL Conversion)
**Files to Modify**:
- `snippets/ks-product-pet-selector.liquid` - Lines 465-468 (image rendering)

**Changes**:
1. Add async blob-to-data URL conversion in `renderPets()` function
2. Convert blob URLs before setting `img.src`
3. Add loading states during conversion
4. Maintain fallback to blob URLs if conversion fails

### Phase 2: Error Prevention
**Additional Safeguards**:
1. Add error handling for URL construction
2. Validate URLs before rendering
3. Add analytics exclusion attributes as backup

### Phase 3: Testing & Monitoring
**Test Scenarios**:
1. Product page with fresh pet processing
2. Product page with cached pet data
3. Multiple pets with all 4 effects
4. Browser console monitoring for URL errors

## Risk Assessment

**Risk Level**: LOW
- Changes isolated to pet selector rendering logic
- Maintains all existing functionality
- Easy rollback if issues occur
- No impact on pet processor core functionality

## Expected Outcomes

After implementation:
- ✅ Eliminates "Failed to construct 'URL'" errors
- ✅ Pet selector works on product pages
- ✅ Processed images display correctly
- ✅ No interference with Shopify analytics
- ✅ Maintains mobile optimization
- ✅ Zero impact on processing page functionality

## Alternative URL Patterns to Avoid

**Problematic**:
- `blob:https://domain.com/uuid` (triggers analytics)
- Relative URLs without protocol
- Empty or null URLs

**Safe**:
- `data:image/jpeg;base64,/9j/4AAQ...` (data URLs)
- Full HTTPS URLs to CDN resources
- Properly constructed absolute URLs

## Files Requiring Changes

### Primary Change
- **File**: `snippets/ks-product-pet-selector.liquid`
- **Lines**: 465-468 (image src assignment)
- **Change**: Convert blob URLs to data URLs before rendering

### Testing Files
- Test product page functionality after changes
- Verify processing page remains unaffected
- Monitor browser console for URL-related errors

The root cause is definitively identified as a conflict between blob URLs and Shopify's analytics system attempting to track image resources with invalid URL construction patterns.